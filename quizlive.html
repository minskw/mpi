<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizLive - Game Kuis Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { box-sizing: border-box; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        .timer-bar { transition: width 1s linear; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-teal-500 min-h-screen">
    <!-- Header -->
    <div class="bg-white/10 backdrop-blur-sm border-b border-white/20">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-white flex items-center cursor-pointer hover:text-yellow-300 transition-colors" onclick="toggleAdminPanel()">
                    <i class="fas fa-bullseye mr-2"></i> QuizLive
                </h1>
                <div id="gameCode" class="bg-white/20 px-4 py-2 rounded-lg text-white font-mono text-lg hidden">
                    Kode: <span id="codeDisplay">ABC123</span>
                </div>
            </div>
        </div>
    </div>



    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Login Screen -->
        <div id="loginScreen" class="text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-md mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-lock text-blue-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Masuk ke QuizLive</h2>
                <p class="text-xl text-white/80 mb-8">Login untuk mengikuti kuis</p>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">NIS (Nomor Induk)</label>
                        <input type="text" id="loginNIS" placeholder="Masukkan NIS Anda" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Password</label>
                        <input type="password" id="loginPassword" placeholder="Masukkan password" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    
                    <button onclick="loginUser()" id="loginBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                        <span id="loginBtnText"><i class="fas fa-rocket mr-2"></i>Masuk</span>
                        <span id="loginBtnLoading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Masuk...
                        </span>
                    </button>
                    
                    <div class="text-center">
                        <p class="text-white/70 mb-4">Belum punya akun?</p>
                        <button onclick="showRegisterScreen()" class="text-yellow-400 hover:text-yellow-300 font-bold underline transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Daftar Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="hidden text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-lg mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-user-plus text-green-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Daftar Akun Baru</h2>
                <p class="text-xl text-white/80 mb-8">Buat akun untuk mengikuti kuis</p>
                
                <div class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">NIS (Nomor Induk)</label>
                            <input type="text" id="registerNIS" placeholder="Contoh: 2024001" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                        </div>
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">Kelas</label>
                            <select id="registerClass" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50" style="background-color: rgba(255,255,255,0.2) !important; color: white !important;">
                                <option value="" style="background-color: #1f2937; color: white;">Pilih Kelas</option>
                                <option value="4A" style="background-color: #1f2937; color: white;">4A</option>
                                <option value="4B" style="background-color: #1f2937; color: white;">4B</option>
                                <option value="5A" style="background-color: #1f2937; color: white;">5A</option>
                                <option value="5B" style="background-color: #1f2937; color: white;">5B</option>
                                <option value="6A" style="background-color: #1f2937; color: white;">6A</option>
                                <option value="6B" style="background-color: #1f2937; color: white;">6B</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Nama Lengkap</label>
                        <input type="text" id="registerName" placeholder="Masukkan nama lengkap" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Password</label>
                        <input type="password" id="registerPassword" placeholder="Buat password (min. 6 karakter)" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Konfirmasi Password</label>
                        <input type="password" id="confirmPassword" placeholder="Ulangi password" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    
                    <button onclick="registerUser()" id="registerBtn" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                        <span id="registerBtnText"><i class="fas fa-user-plus mr-2"></i>Daftar Akun</span>
                        <span id="registerBtnLoading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Mendaftar...
                        </span>
                    </button>
                    
                    <div class="text-center">
                        <p class="text-white/70 mb-4">Sudah punya akun?</p>
                        <button onclick="showLoginScreen()" class="text-yellow-400 hover:text-yellow-300 font-bold underline transition-colors">
                            <i class="fas fa-sign-in-alt mr-2"></i>Masuk Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Welcome Screen (After Login) -->
        <div id="welcomeScreen" class="hidden text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-2xl mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-graduation-cap text-yellow-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Selamat Datang, <span id="welcomeUserName">Siswa</span>!</h2>
                <p class="text-xl text-white/80 mb-8">Siap mengikuti kuis hari ini?</p>
                
                <div class="bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-2xl p-8 border border-white/30 mb-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">Kode Kuis</label>
                            <input type="text" id="joinCode" placeholder="Contoh: ABC123" class="w-full px-6 py-4 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center text-2xl font-mono tracking-widest uppercase">
                        </div>
                        <button onclick="joinGame()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-rocket mr-2"></i>Gabung Kuis
                        </button>
                        
                        <div class="pt-4 border-t border-white/20">
                            <button onclick="logoutUser()" class="text-white/70 hover:text-white transition-colors underline">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-4xl w-full border border-white/20 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">👩‍🏫 Panel Admin Guru</h2>
                    <button onclick="closeAdminPanel()" class="text-white/60 hover:text-white text-2xl">✕</button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Create New Quiz -->
                    <div class="bg-gradient-to-br from-purple-500/20 to-blue-500/20 rounded-2xl p-6 border border-white/30">
                        <div class="text-4xl mb-4">🎯</div>
                        <h3 class="text-xl font-bold text-white mb-3">Buat Kuis Baru</h3>
                        <p class="text-white/70 text-sm mb-6">Buat soal sendiri atau gunakan contoh</p>
                        
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-white/80 mb-2">Nama Kuis</label>
                                <input type="text" id="quizName" placeholder="Contoh: Kuis Matematika Kelas 7" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-white/80 mb-2">Mata Pelajaran</label>
                                    <select id="quizSubject" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30">
                                        <option value="">Pilih Mapel</option>
                                        <option value="Matematika">Matematika</option>
                                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                        <option value="Bahasa Inggris">Bahasa Inggris</option>
                                        <option value="IPA">IPA</option>
                                        <option value="IPS">IPS</option>
                                        <option value="PKN">PKN</option>
                                        <option value="Agama">Agama</option>
                                        <option value="Seni Budaya">Seni Budaya</option>
                                        <option value="PJOK">PJOK</option>
                                        <option value="Prakarya">Prakarya</option>
                                        <option value="Fisika">Fisika</option>
                                        <option value="Kimia">Kimia</option>
                                        <option value="Biologi">Biologi</option>
                                        <option value="Sejarah">Sejarah</option>
                                        <option value="Geografi">Geografi</option>
                                        <option value="Ekonomi">Ekonomi</option>
                                        <option value="Sosiologi">Sosiologi</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-white/80 mb-2">Kelas</label>
                                    <select id="quizClass" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30" style="background-color: rgba(255,255,255,0.2) !important; color: white !important;">
                                        <option value="" style="background-color: #1f2937; color: white;">Pilih Kelas</option>
                                        <option value="4A" style="background-color: #1f2937; color: white;">4A</option>
                                        <option value="4B" style="background-color: #1f2937; color: white;">4B</option>
                                        <option value="5A" style="background-color: #1f2937; color: white;">5A</option>
                                        <option value="5B" style="background-color: #1f2937; color: white;">5B</option>
                                        <option value="6A" style="background-color: #1f2937; color: white;">6A</option>
                                        <option value="6B" style="background-color: #1f2937; color: white;">6B</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-white/80 mb-2">Nama Guru</label>
                                <input type="text" id="teacherName" placeholder="Nama Anda" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
                            </div>
                            <div>
                                <label class="block text-white/80 mb-2">Waktu per Soal</label>
                                <select id="adminTimeLimit" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30">
                                    <option value="10">10 detik</option>
                                    <option value="15" selected>15 detik</option>
                                    <option value="30">30 detik</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="showQuestionBuilder()" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 text-sm">
                                ✏️ Buat Soal Sendiri
                            </button>
                            <button onclick="showExcelImport()" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 text-sm">
                                📊 Import dari Excel
                            </button>
                            <button onclick="createQuizWithSamples()" class="bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 text-sm">
                                🚀 Pakai Contoh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quiz Library -->
                    <div class="bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-2xl p-6 border border-white/30">
                        <div class="text-4xl mb-4">📚</div>
                        <h3 class="text-xl font-bold text-white mb-3">Library Kuis</h3>
                        <p class="text-white/70 text-sm mb-6">Kelola dan mainkan kuis tersimpan</p>
                        
                        <div id="liveStats" class="space-y-4 mb-6">
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-white/80">Kuis Tersimpan</span>
                                    <span class="text-white font-bold text-xl" id="savedQuizCount">0</span>
                                </div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-white/80">Total Peserta</span>
                                    <span class="text-white font-bold text-xl" id="totalParticipants">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="showQuizLibrary()" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 text-sm">
                                📚 Buka Library Kuis
                            </button>
                            <button onclick="showMonitoringPanel()" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 text-sm">
                                📊 Monitoring Live
                            </button>
                            <button onclick="showResultsManager()" class="bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 text-sm">
                                📋 Kelola Hasil
                            </button>
                            <button onclick="refreshStats()" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 text-sm">
                                🔄 Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Excel Import Panel -->
        <div id="excelImport" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-4xl w-full border border-white/20 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">📊 Import Soal dari Excel</h2>
                    <button onclick="closeExcelImport()" class="text-white/60 hover:text-white text-2xl">✕</button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Upload Section -->
                    <div class="space-y-6">
                        <div class="bg-gradient-to-br from-orange-500/20 to-red-500/20 rounded-2xl p-6 border border-white/30">
                            <h3 class="text-xl font-bold text-white mb-4">📁 Upload File Excel</h3>
                            
                            <div class="space-y-4">
                                <div class="border-2 border-dashed border-white/30 rounded-lg p-6 text-center">
                                    <div class="text-4xl mb-4">📄</div>
                                    <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden" onchange="handleExcelFile(event)">
                                    <button onclick="document.getElementById('excelFile').click()" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300">
                                        📂 Pilih File Excel
                                    </button>
                                    <p class="text-white/60 text-sm mt-2">Format: .xlsx atau .xls</p>
                                </div>
                                
                                <div id="fileInfo" class="hidden bg-white/10 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="text-white font-medium" id="fileName">file.xlsx</div>
                                            <div class="text-white/60 text-sm" id="fileSize">0 KB</div>
                                        </div>
                                        <div class="text-green-400">✅</div>
                                    </div>
                                </div>
                                
                                <button onclick="processExcelFile()" id="processBtn" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 disabled:opacity-50" disabled>
                                    🔄 Proses File Excel
                                </button>
                            </div>
                        </div>
                        
                        <!-- Template Download -->
                        <div class="bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl p-6 border border-white/30">
                            <h3 class="text-xl font-bold text-white mb-4">📋 Template Excel</h3>
                            <p class="text-white/70 text-sm mb-4">Download template untuk format yang benar</p>
                            <button onclick="downloadTemplate()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300">
                                ⬇️ Download Template
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview Section -->
                    <div class="bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-2xl p-6 border border-white/30">
                        <h3 class="text-xl font-bold text-white mb-4">👁️ Preview Soal (<span id="excelQuestionCount">0</span>)</h3>
                        <div id="excelQuestionsList" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-white/60 text-center py-8">
                                Upload file Excel untuk melihat preview soal
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-white/20">
                            <button onclick="createQuizFromExcel()" id="createFromExcelBtn" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 disabled:opacity-50" disabled>
                                🚀 Buat Kuis dari Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Panel -->
        <div id="monitoringPanel" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-6xl w-full border border-white/20 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">📊 Monitoring Live Kuis</h2>
                    <button onclick="closeMonitoringPanel()" class="text-white/60 hover:text-white text-2xl">✕</button>
                </div>
                
                <!-- Active Quiz Info -->
                <div id="activeQuizInfo" class="bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl p-6 border border-white/30 mb-8">
                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="bg-white/10 rounded-lg p-4 text-center">
                            <div class="text-2xl mb-2">🎯</div>
                            <div class="text-white font-bold" id="monitorQuizTitle">Tidak Ada Kuis Aktif</div>
                            <div class="text-white/60 text-sm" id="monitorQuizCode">-</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4 text-center">
                            <div class="text-2xl mb-2">👥</div>
                            <div class="text-white font-bold text-xl" id="monitorParticipantCount">0</div>
                            <div class="text-white/60 text-sm">Peserta Terdaftar</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4 text-center">
                            <div class="text-2xl mb-2">📚</div>
                            <div class="text-white font-bold" id="monitorQuizClass">-</div>
                            <div class="text-white/60 text-sm">Kelas</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4 text-center">
                            <div class="text-2xl mb-2">📖</div>
                            <div class="text-white font-bold" id="monitorQuizSubject">-</div>
                            <div class="text-white/60 text-sm">Mata Pelajaran</div>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="startActiveQuiz()" id="startQuizBtn" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 disabled:opacity-50" disabled>
                            🚀 Mulai Kuis Sekarang
                        </button>
                    </div>
                </div>
                
                <!-- Live Participants -->
                <div class="bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-2xl p-6 border border-white/30">
                    <h3 class="text-xl font-bold text-white mb-4">👥 Peserta Live (<span id="liveParticipantCount">0</span>)</h3>
                    <div id="liveParticipantsList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                        <div class="text-white/60 text-center py-8 col-span-full">
                            Belum ada peserta yang bergabung
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Manager Panel -->
        <div id="resultsManager" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-6xl w-full border border-white/20 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">📋 Kelola Hasil Kuis</h2>
                    <button onclick="closeResultsManager()" class="text-white/60 hover:text-white text-2xl">✕</button>
                </div>
                
                <!-- Filter Results -->
                <div class="bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl p-6 border border-white/30 mb-8">
                    <div class="grid md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-white/80 mb-2">🔍 Cari Kuis</label>
                            <input type="text" id="searchResults" placeholder="Nama kuis..." class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50" onkeyup="filterResults()">
                        </div>
                        <div>
                            <label class="block text-white/80 mb-2">📚 Kelas</label>
                            <select id="filterClass" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30" style="background-color: rgba(255,255,255,0.2) !important; color: white !important;" onchange="filterResults()">
                                <option value="" style="background-color: #1f2937; color: white;">Semua Kelas</option>
                                <option value="4A" style="background-color: #1f2937; color: white;">4A</option>
                                <option value="4B" style="background-color: #1f2937; color: white;">4B</option>
                                <option value="5A" style="background-color: #1f2937; color: white;">5A</option>
                                <option value="5B" style="background-color: #1f2937; color: white;">5B</option>
                                <option value="6A" style="background-color: #1f2937; color: white;">6A</option>
                                <option value="6B" style="background-color: #1f2937; color: white;">6B</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white/80 mb-2">📖 Mapel</label>
                            <select id="filterSubject" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30" onchange="filterResults()">
                                <option value="">Semua Mapel</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                <option value="IPA">IPA</option>
                                <option value="IPS">IPS</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white/80 mb-2">📅 Periode</label>
                            <select id="filterPeriod" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30" onchange="filterResults()">
                                <option value="">Semua Waktu</option>
                                <option value="today">Hari Ini</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Results List -->
                <div id="resultsList" class="space-y-4">
                    <!-- Results will be loaded here -->
                </div>
                
                <!-- Empty State -->
                <div id="resultsEmptyState" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">📊</div>
                    <h3 class="text-2xl font-bold text-white mb-2">Belum Ada Hasil</h3>
                    <p class="text-white/70">Buat dan jalankan kuis untuk melihat hasil</p>
                </div>
            </div>
        </div>

        <!-- Quiz Library Panel -->
        <div id="quizLibrary" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-6xl w-full border border-white/20 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">📚 Library Kuis</h2>
                    <button onclick="closeQuizLibrary()" class="text-white/60 hover:text-white text-2xl">✕</button>
                </div>
                
                <!-- Search and Filter -->
                <div class="bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl p-6 border border-white/30 mb-8">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-white/80 mb-2">🔍 Cari Kuis</label>
                            <input type="text" id="searchQuiz" placeholder="Nama kuis atau guru..." class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50" onkeyup="filterQuizzes()">
                        </div>
                        <div>
                            <label class="block text-white/80 mb-2">📊 Status</label>
                            <select id="statusFilter" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30" onchange="filterQuizzes()">
                                <option value="">Semua Status</option>
                                <option value="waiting">Menunggu</option>
                                <option value="active">Aktif</option>
                                <option value="completed">Selesai</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white/80 mb-2">📅 Urutkan</label>
                            <select id="sortOrder" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30" onchange="filterQuizzes()">
                                <option value="newest">Terbaru</option>
                                <option value="oldest">Terlama</option>
                                <option value="name">Nama A-Z</option>
                                <option value="participants">Peserta Terbanyak</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz List -->
                <div id="quizList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Quizzes will be loaded here -->
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">📝</div>
                    <h3 class="text-2xl font-bold text-white mb-2">Belum Ada Kuis</h3>
                    <p class="text-white/70 mb-6">Buat kuis pertama Anda untuk mulai mengajar!</p>
                    <button onclick="closeQuizLibrary()" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300">
                        ➕ Buat Kuis Baru
                    </button>
                </div>
            </div>
        </div>

        <!-- Question Builder Panel -->
        <div id="questionBuilder" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-4xl w-full border border-white/20 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">✏️ Buat Soal Kuis</h2>
                    <button onclick="closeQuestionBuilder()" class="text-white/60 hover:text-white text-2xl">✕</button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Question Form -->
                    <div class="space-y-6">
                        <div class="bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl p-6 border border-white/30">
                            <h3 class="text-xl font-bold text-white mb-4">📝 Soal #<span id="questionNumber">1</span></h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-white/80 mb-2">Pertanyaan</label>
                                    <textarea id="questionInput" placeholder="Tulis pertanyaan di sini..." class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 h-20 resize-none"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-white/80 mb-2">Pilihan Jawaban</label>
                                    <div class="space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <input type="radio" name="correctAnswer" value="0" id="correct0" class="text-green-500">
                                            <label class="text-white/60 text-sm">A.</label>
                                            <input type="text" id="option0" placeholder="Pilihan A" class="flex-1 px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <input type="radio" name="correctAnswer" value="1" id="correct1" class="text-green-500">
                                            <label class="text-white/60 text-sm">B.</label>
                                            <input type="text" id="option1" placeholder="Pilihan B" class="flex-1 px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <input type="radio" name="correctAnswer" value="2" id="correct2" class="text-green-500">
                                            <label class="text-white/60 text-sm">C.</label>
                                            <input type="text" id="option2" placeholder="Pilihan C" class="flex-1 px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <input type="radio" name="correctAnswer" value="3" id="correct3" class="text-green-500">
                                            <label class="text-white/60 text-sm">D.</label>
                                            <input type="text" id="option3" placeholder="Pilihan D" class="flex-1 px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
                                        </div>
                                    </div>
                                    <p class="text-white/60 text-xs mt-2">💡 Pilih radio button untuk jawaban yang benar</p>
                                </div>
                                
                                <div class="flex space-x-3">
                                    <button onclick="addQuestion()" class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                        ➕ Tambah Soal
                                    </button>
                                    <button onclick="finishQuestions()" class="flex-1 bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                        ✅ Selesai & Mulai
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Questions Preview -->
                    <div class="bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-2xl p-6 border border-white/30">
                        <h3 class="text-xl font-bold text-white mb-4">📋 Daftar Soal (<span id="questionCount">0</span>)</h3>
                        <div id="questionsList" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-white/60 text-center py-8">
                                Belum ada soal. Mulai buat soal pertama!
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-white/20">
                            <button onclick="clearAllQuestions()" class="w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-2 px-4 rounded-xl transition-all duration-300 text-sm">
                                🗑️ Hapus Semua Soal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="hidden">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-4xl mx-auto border border-white/20">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2" id="lobbyTitle">Ruang Tunggu Kelas</h2>
                    <p class="text-white/80" id="lobbySubtitle">Menunggu guru memulai kuis...</p>
                </div>
                
                <div class="bg-white/10 rounded-2xl p-6 mb-8">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        👥 Peserta Online (<span id="participantCount">0</span>)
                    </h3>
                    <div id="participantsList" class="space-y-3">
                        <!-- Participants will be loaded from database -->
                    </div>
                </div>
                
                <div class="text-center">
                    <div id="waitingMessage" class="text-white/80 text-lg">
                        ⏳ Menunggu guru memulai kuis...
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <!-- Timer Bar -->
            <div class="bg-white/20 rounded-full h-3 mb-6 overflow-hidden">
                <div id="timerBar" class="bg-gradient-to-r from-red-500 to-yellow-500 h-full timer-bar" style="width: 100%"></div>
            </div>
            
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-4xl mx-auto border border-white/20 animate-slide-in">
                <!-- Question Header -->
                <div class="text-center mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-white/80">Soal <span id="currentQuestion">1</span> dari <span id="totalQuestions">10</span></span>
                        <span class="text-white/80">Skor: <span id="currentScore" class="text-yellow-400 font-bold">0</span></span>
                    </div>
                    <h3 id="questionText" class="text-2xl font-bold text-white mb-2">Loading...</h3>
                    <div id="timeRemaining" class="text-xl text-yellow-400 font-bold">⏰ 15</div>
                </div>
                
                <!-- Answer Options -->
                <div id="answerOptions" class="grid md:grid-cols-2 gap-4">
                    <!-- Options will be loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-4xl mx-auto border border-white/20">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">🏆</div>
                    <h2 class="text-4xl font-bold text-white mb-2">Kuis Selesai!</h2>
                    <p class="text-xl text-white/80">Hasil dari database real-time</p>
                </div>
                
                <!-- Leaderboard -->
                <div class="bg-white/10 rounded-2xl p-6 mb-8">
                    <h3 class="text-2xl font-bold text-white mb-6 text-center">🥇 Papan Peringkat</h3>
                    <div id="leaderboard" class="space-y-4">
                        <!-- Leaderboard will be loaded from database -->
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="backToHome()" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300">
                        🏠 Kembali ke Beranda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Kredensial Supabase - Terhubung ke database
        const SUPABASE_URL = 'https://lglhmbdsldqlcjnkampd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnbGhtYmRzbGRxbGNqbmthbXBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDc4NTgsImV4cCI6MjA3NTEyMzg1OH0.857DRQpbvcfSaVtNDkgBKvx2PYvEfmA8-mlPiiZ6Ib0';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Game State
        let gameState = {
            currentScreen: 'login',
            currentQuiz: null,
            currentParticipant: null,
            currentUser: null,
            currentQuestionIndex: 0,
            score: 0,
            timeRemaining: 15,
            timer: null,
            questions: []
        };

        // Question Builder State
        let questionBuilder = {
            questions: [],
            currentQuestionNumber: 1
        };

        // Excel Import State
        let excelImport = {
            file: null,
            questions: []
        };

        // Quiz Library State
        let quizLibrary = {
            allQuizzes: [],
            filteredQuizzes: []
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            setupRealtimeSubscriptions();
            checkUserSession();
        });

        // Check if user is already logged in
        function checkUserSession() {
            const savedUser = localStorage.getItem('quizlive_user');
            if (savedUser) {
                gameState.currentUser = JSON.parse(savedUser);
                document.getElementById('welcomeUserName').textContent = gameState.currentUser.name;
                showScreen('welcomeScreen');
            } else {
                showScreen('loginScreen');
            }
        }

        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginNIS').value = '';
            document.getElementById('loginPassword').value = '';
            showScreen('loginScreen');
        }

        // Show register screen
        function showRegisterScreen() {
            document.getElementById('registerNIS').value = '';
            document.getElementById('registerName').value = '';
            document.getElementById('registerClass').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            showScreen('registerScreen');
        }

        // Register new user
        async function registerUser() {
            const nis = document.getElementById('registerNIS').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const studentClass = document.getElementById('registerClass').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validation
            if (!nis || !name || !studentClass || !password || !confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Data Tidak Lengkap',
                    text: 'Mohon lengkapi semua data yang diperlukan!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            if (password.length < 6) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Terlalu Pendek',
                    text: 'Password minimal harus 6 karakter!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            if (password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Tidak Cocok',
                    text: 'Konfirmasi password tidak sesuai dengan password yang dimasukkan!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading state
            const registerBtn = document.getElementById('registerBtn');
            const registerBtnText = document.getElementById('registerBtnText');
            const registerBtnLoading = document.getElementById('registerBtnLoading');
            
            registerBtn.disabled = true;
            registerBtnText.classList.add('hidden');
            registerBtnLoading.classList.remove('hidden');

            try {
                // Show processing notification
                Swal.fire({
                    title: 'Memproses Pendaftaran...',
                    text: 'Mohon tunggu sebentar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Check if NIS already exists
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('*')
                    .eq('nis', nis)
                    .single();

                if (existingUser) {
                    Swal.fire({
                        icon: 'error',
                        title: 'NIS Sudah Terdaftar',
                        text: 'NIS ini sudah digunakan. Gunakan NIS lain atau silakan login.',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }

                // Create new user
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([{
                        nis: nis,
                        name: name,
                        class: studentClass,
                        password: password
                    }])
                    .select()
                    .single();

                if (error) throw error;

                Swal.fire({
                    icon: 'success',
                    title: 'Pendaftaran Berhasil!',
                    text: `Akun untuk ${name} berhasil dibuat. Silakan login dengan NIS dan password Anda.`,
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    showLoginScreen();
                });

            } catch (error) {
                console.error('Registration error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Pendaftaran Gagal',
                    text: 'Terjadi kesalahan: ' + error.message,
                    confirmButtonColor: '#3b82f6'
                });
            } finally {
                // Reset button state
                registerBtn.disabled = false;
                registerBtnText.classList.remove('hidden');
                registerBtnLoading.classList.add('hidden');
            }
        }

        // Login user
        async function loginUser() {
            const nis = document.getElementById('loginNIS').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!nis || !password) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Belum Lengkap',
                    text: 'Mohon masukkan NIS dan password Anda!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading state
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginBtnLoading = document.getElementById('loginBtnLoading');
            
            loginBtn.disabled = true;
            loginBtnText.classList.add('hidden');
            loginBtnLoading.classList.remove('hidden');

            try {
                // Show processing notification
                Swal.fire({
                    title: 'Memproses Login...',
                    text: 'Mohon tunggu sebentar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('nis', nis)
                    .eq('password', password)
                    .single();

                if (error || !user) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Login Gagal',
                        text: 'NIS atau password yang Anda masukkan salah!',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }

                // Save user session
                gameState.currentUser = user;
                localStorage.setItem('quizlive_user', JSON.stringify(user));
                
                document.getElementById('welcomeUserName').textContent = user.name;
                showScreen('welcomeScreen');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Login Berhasil!',
                    text: `Selamat datang, ${user.name}! Kelas ${user.class}`,
                    confirmButtonColor: '#10b981',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('Login error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Login Gagal',
                    text: 'Terjadi kesalahan: ' + error.message,
                    confirmButtonColor: '#3b82f6'
                });
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtnText.classList.remove('hidden');
                loginBtnLoading.classList.add('hidden');
            }
        }

        // Logout user
        function logoutUser() {
            Swal.fire({
                title: 'Konfirmasi Keluar',
                text: 'Apakah Anda yakin ingin keluar dari akun?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    gameState.currentUser = null;
                    gameState.currentQuiz = null;
                    gameState.currentParticipant = null;
                    localStorage.removeItem('quizlive_user');
                    document.getElementById('gameCode').classList.add('hidden');
                    document.getElementById('joinCode').value = '';
                    showScreen('loginScreen');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil Keluar',
                        text: 'Anda telah keluar dari akun. Sampai jumpa!',
                        confirmButtonColor: '#10b981',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }



        // Setup real-time subscriptions
        function setupRealtimeSubscriptions() {
            // Subscribe to participants changes
            supabase
                .channel('participants')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'participants' }, (payload) => {
                    if (gameState.currentQuiz) {
                        loadParticipants();
                    }
                })
                .subscribe();

            // Subscribe to quiz status changes
            supabase
                .channel('quizzes')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'quizzes' }, (payload) => {
                    if (gameState.currentQuiz && payload.new.id === gameState.currentQuiz.id) {
                        if (payload.new.status === 'active' && gameState.currentScreen === 'lobbyScreen') {
                            startGameFromDatabase();
                        }
                    }
                })
                .subscribe();
        }

        // Show Excel import
        function showExcelImport() {
            excelImport.file = null;
            excelImport.questions = [];
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('processBtn').disabled = true;
            document.getElementById('createFromExcelBtn').disabled = true;
            updateExcelQuestionsList();
            document.getElementById('excelImport').classList.remove('hidden');
        }

        // Close Excel import
        function closeExcelImport() {
            document.getElementById('excelImport').classList.add('hidden');
        }

        // Handle Excel file selection
        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            excelImport.file = file;
            
            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('processBtn').disabled = false;
        }

        // Process Excel file
        function processExcelFile() {
            if (!excelImport.file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Parse questions
                    const questions = parseExcelQuestions(jsonData);
                    
                    if (questions.length === 0) {
                        alert('❌ Tidak ada soal valid ditemukan!\nPastikan format Excel sesuai template.');
                        return;
                    }
                    
                    excelImport.questions = questions;
                    updateExcelQuestionsList();
                    document.getElementById('createFromExcelBtn').disabled = false;
                    
                    alert(`✅ Berhasil memproses ${questions.length} soal dari Excel!`);
                    
                } catch (error) {
                    console.error('Error processing Excel:', error);
                    alert('❌ Gagal memproses file Excel!\nPastikan format file benar.');
                }
            };
            
            reader.readAsArrayBuffer(excelImport.file);
        }

        // Parse Excel questions
        function parseExcelQuestions(data) {
            const questions = [];
            
            // Skip header row, start from row 1
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                
                // Skip empty rows
                if (!row || row.length < 6) continue;
                
                const questionText = row[0]?.toString().trim();
                const optionA = row[1]?.toString().trim();
                const optionB = row[2]?.toString().trim();
                const optionC = row[3]?.toString().trim();
                const optionD = row[4]?.toString().trim();
                const correctAnswer = row[5]?.toString().trim().toUpperCase();
                
                // Validate required fields
                if (!questionText || !optionA || !optionB || !optionC || !optionD || !correctAnswer) {
                    continue;
                }
                
                // Convert correct answer to index
                let correctIndex = -1;
                switch (correctAnswer) {
                    case 'A': correctIndex = 0; break;
                    case 'B': correctIndex = 1; break;
                    case 'C': correctIndex = 2; break;
                    case 'D': correctIndex = 3; break;
                    default: continue; // Skip invalid answers
                }
                
                questions.push({
                    question_text: questionText,
                    options: [optionA, optionB, optionC, optionD],
                    correct_answer: correctIndex,
                    order_number: questions.length + 1
                });
            }
            
            return questions;
        }

        // Update Excel questions list
        function updateExcelQuestionsList() {
            const questionsList = document.getElementById('excelQuestionsList');
            const questionCount = document.getElementById('excelQuestionCount');
            
            questionCount.textContent = excelImport.questions.length;
            
            if (excelImport.questions.length === 0) {
                questionsList.innerHTML = `
                    <div class="text-white/60 text-center py-8">
                        Upload file Excel untuk melihat preview soal
                    </div>
                `;
                return;
            }

            questionsList.innerHTML = excelImport.questions.map((q, index) => `
                <div class="bg-white/20 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-white font-bold text-sm">Soal ${index + 1}</span>
                        <span class="text-green-400 text-xs">Excel</span>
                    </div>
                    <p class="text-white/80 text-sm mb-2">${q.question_text}</p>
                    <div class="text-xs text-white/60">
                        Jawaban: ${String.fromCharCode(65 + q.correct_answer)}. ${q.options[q.correct_answer]}
                    </div>
                </div>
            `).join('');
        }

        // Create quiz from Excel
        async function createQuizFromExcel() {
            if (excelImport.questions.length === 0) {
                alert('❌ Tidak ada soal untuk dibuat kuis!');
                return;
            }

            const title = document.getElementById('quizName').value || 'Kuis dari Excel';
            const teacherName = document.getElementById('teacherName').value || 'Guru';
            const timeLimit = parseInt(document.getElementById('adminTimeLimit').value);
            
            try {
                const code = generateGameCode();
                
                // Create quiz
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .insert([{
                        title: title,
                        code: code,
                        creator_name: teacherName,
                        question_count: excelImport.questions.length,
                        time_limit: timeLimit,
                        status: 'waiting'
                    }])
                    .select()
                    .single();

                if (quizError) throw quizError;

                // Insert Excel questions
                const questionsToInsert = excelImport.questions.map(q => ({
                    ...q,
                    quiz_id: quiz.id
                }));

                const { error: questionsError } = await supabase
                    .from('questions')
                    .insert(questionsToInsert);

                if (questionsError) throw questionsError;

                gameState.currentQuiz = quiz;
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                closeExcelImport();
                closeAdminPanel();
                alert(`✅ Kuis "${title}" berhasil dibuat dari Excel!\nKode: ${code}\nTotal: ${excelImport.questions.length} soal\nBagikan kode ini ke siswa.`);
                
                await startQuiz();
                
            } catch (error) {
                console.error('Error creating quiz from Excel:', error);
                alert('❌ Gagal membuat kuis dari Excel: ' + error.message);
            }
        }

        // Download Excel template
        function downloadTemplate() {
            // Create template data
            const templateData = [
                ['Pertanyaan', 'Pilihan A', 'Pilihan B', 'Pilihan C', 'Pilihan D', 'Jawaban Benar'],
                ['Apa ibu kota Indonesia?', 'Jakarta', 'Bandung', 'Surabaya', 'Medan', 'A'],
                ['Siapa presiden pertama Indonesia?', 'Soekarno', 'Soeharto', 'Habibie', 'Megawati', 'A'],
                ['Berapa jumlah pulau di Indonesia?', '13.000', '17.508', '20.000', '15.000', 'B']
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Set column widths
            ws['!cols'] = [
                { width: 40 }, // Pertanyaan
                { width: 20 }, // Pilihan A
                { width: 20 }, // Pilihan B
                { width: 20 }, // Pilihan C
                { width: 20 }, // Pilihan D
                { width: 15 }  // Jawaban Benar
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Template Soal');
            
            // Download file
            XLSX.writeFile(wb, 'Template_Soal_QuizLive.xlsx');
            
            alert('✅ Template Excel berhasil didownload!\nIsi template dengan soal Anda, lalu upload kembali.');
        }

        // Show question builder
        function showQuestionBuilder() {
            questionBuilder.questions = [];
            questionBuilder.currentQuestionNumber = 1;
            updateQuestionNumber();
            clearQuestionForm();
            updateQuestionsList();
            document.getElementById('questionBuilder').classList.remove('hidden');
        }

        // Close question builder
        function closeQuestionBuilder() {
            document.getElementById('questionBuilder').classList.add('hidden');
        }

        // Add question to builder
        function addQuestion() {
            const questionText = document.getElementById('questionInput').value.trim();
            const options = [
                document.getElementById('option0').value.trim(),
                document.getElementById('option1').value.trim(),
                document.getElementById('option2').value.trim(),
                document.getElementById('option3').value.trim()
            ];
            
            const correctAnswer = document.querySelector('input[name="correctAnswer"]:checked');
            
            if (!questionText) {
                alert('❌ Masukkan pertanyaan!');
                return;
            }
            
            if (options.some(opt => !opt)) {
                alert('❌ Isi semua pilihan jawaban!');
                return;
            }
            
            if (!correctAnswer) {
                alert('❌ Pilih jawaban yang benar!');
                return;
            }

            const question = {
                question_text: questionText,
                options: options,
                correct_answer: parseInt(correctAnswer.value),
                order_number: questionBuilder.questions.length + 1
            };

            questionBuilder.questions.push(question);
            questionBuilder.currentQuestionNumber++;
            
            clearQuestionForm();
            updateQuestionNumber();
            updateQuestionsList();
            
            alert(`✅ Soal ${questionBuilder.questions.length} berhasil ditambahkan!`);
        }

        // Clear question form
        function clearQuestionForm() {
            document.getElementById('questionInput').value = '';
            document.getElementById('option0').value = '';
            document.getElementById('option1').value = '';
            document.getElementById('option2').value = '';
            document.getElementById('option3').value = '';
            document.querySelectorAll('input[name="correctAnswer"]').forEach(radio => radio.checked = false);
        }

        // Update question number display
        function updateQuestionNumber() {
            document.getElementById('questionNumber').textContent = questionBuilder.currentQuestionNumber;
        }

        // Update questions list
        function updateQuestionsList() {
            const questionsList = document.getElementById('questionsList');
            const questionCount = document.getElementById('questionCount');
            
            questionCount.textContent = questionBuilder.questions.length;
            
            if (questionBuilder.questions.length === 0) {
                questionsList.innerHTML = `
                    <div class="text-white/60 text-center py-8">
                        Belum ada soal. Mulai buat soal pertama!
                    </div>
                `;
                return;
            }

            questionsList.innerHTML = questionBuilder.questions.map((q, index) => `
                <div class="bg-white/20 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-white font-bold text-sm">Soal ${index + 1}</span>
                        <button onclick="removeQuestion(${index})" class="text-red-400 hover:text-red-300 text-sm">🗑️</button>
                    </div>
                    <p class="text-white/80 text-sm mb-2">${q.question_text}</p>
                    <div class="text-xs text-white/60">
                        Jawaban: ${String.fromCharCode(65 + q.correct_answer)}. ${q.options[q.correct_answer]}
                    </div>
                </div>
            `).join('');
        }

        // Remove question
        function removeQuestion(index) {
            if (confirm('Hapus soal ini?')) {
                questionBuilder.questions.splice(index, 1);
                // Update order numbers
                questionBuilder.questions.forEach((q, i) => {
                    q.order_number = i + 1;
                });
                updateQuestionsList();
            }
        }

        // Clear all questions
        function clearAllQuestions() {
            if (confirm('Hapus semua soal?')) {
                questionBuilder.questions = [];
                questionBuilder.currentQuestionNumber = 1;
                updateQuestionNumber();
                updateQuestionsList();
            }
        }

        // Finish questions and create quiz
        async function finishQuestions() {
            if (questionBuilder.questions.length === 0) {
                alert('❌ Buat minimal 1 soal!');
                return;
            }

            const title = document.getElementById('quizName').value || 'Kuis Baru';
            const teacherName = document.getElementById('teacherName').value || 'Guru';
            const timeLimit = parseInt(document.getElementById('adminTimeLimit').value);
            
            try {
                const code = generateGameCode();
                
                // Create quiz
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .insert([{
                        title: title,
                        code: code,
                        creator_name: teacherName,
                        question_count: questionBuilder.questions.length,
                        time_limit: timeLimit,
                        status: 'waiting'
                    }])
                    .select()
                    .single();

                if (quizError) throw quizError;

                // Insert custom questions
                const questionsToInsert = questionBuilder.questions.map(q => ({
                    ...q,
                    quiz_id: quiz.id
                }));

                const { error: questionsError } = await supabase
                    .from('questions')
                    .insert(questionsToInsert);

                if (questionsError) throw questionsError;

                gameState.currentQuiz = quiz;
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                closeQuestionBuilder();
                closeAdminPanel();
                alert(`✅ Kuis "${title}" berhasil dibuat!\nKode: ${code}\nTotal: ${questionBuilder.questions.length} soal\nBagikan kode ini ke siswa.`);
                
                await startQuiz();
                
            } catch (error) {
                console.error('Error creating quiz:', error);
                alert('❌ Gagal membuat kuis: ' + error.message);
            }
        }

        // Create quiz with sample questions (original function)
        async function createQuizWithSamples() {
            const title = document.getElementById('quizName').value || 'Kuis Baru';
            const teacherName = document.getElementById('teacherName').value || 'Guru';
            const subject = document.getElementById('quizSubject').value;
            const quizClass = document.getElementById('quizClass').value;
            const timeLimit = parseInt(document.getElementById('adminTimeLimit').value);
            
            if (!subject || !quizClass) {
                alert('❌ Pilih mata pelajaran dan kelas terlebih dahulu!');
                return;
            }
            
            try {
                // Generate unique code
                const code = generateGameCode();
                
                // Create quiz
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .insert([{
                        title: title,
                        code: code,
                        creator_name: teacherName,
                        subject: subject,
                        class: quizClass,
                        question_count: 5,
                        time_limit: timeLimit,
                        status: 'waiting'
                    }])
                    .select()
                    .single();

                if (quizError) throw quizError;

                // Insert sample questions
                const sampleQuestions = [
                    {
                        question_text: "Apa ibu kota Indonesia?",
                        options: ["Jakarta", "Bandung", "Surabaya", "Medan"],
                        correct_answer: 0,
                        order_number: 1
                    },
                    {
                        question_text: "Siapa presiden pertama Indonesia?",
                        options: ["Soekarno", "Soeharto", "Habibie", "Megawati"],
                        correct_answer: 0,
                        order_number: 2
                    },
                    {
                        question_text: "Berapa jumlah pulau di Indonesia?",
                        options: ["13.000", "17.508", "20.000", "15.000"],
                        correct_answer: 1,
                        order_number: 3
                    },
                    {
                        question_text: "Apa mata uang Indonesia?",
                        options: ["Ringgit", "Rupiah", "Baht", "Peso"],
                        correct_answer: 1,
                        order_number: 4
                    },
                    {
                        question_text: "Gunung tertinggi di Indonesia adalah?",
                        options: ["Gunung Merapi", "Gunung Bromo", "Puncak Jaya", "Gunung Rinjani"],
                        correct_answer: 2,
                        order_number: 5
                    }
                ];

                const questionsToInsert = sampleQuestions.map(q => ({
                    ...q,
                    quiz_id: quiz.id
                }));

                const { error: questionsError } = await supabase
                    .from('questions')
                    .insert(questionsToInsert);

                if (questionsError) throw questionsError;

                gameState.currentQuiz = quiz;
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                closeAdminPanel();
                alert(`✅ Kuis "${title}" berhasil dibuat!\nKode: ${code}\nBagikan kode ini ke siswa.`);
                
                // Start quiz immediately
                await startQuiz();
                
            } catch (error) {
                console.error('Error creating quiz:', error);
                alert('❌ Gagal membuat kuis: ' + error.message);
            }
        }

        // Join game
        async function joinGame() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            if (!code) {
                alert('❌ Masukkan kode kuis!');
                return;
            }

            if (!gameState.currentUser) {
                alert('❌ Anda harus login terlebih dahulu!');
                showLoginScreen();
                return;
            }

            try {
                // Find quiz by code
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .select('*')
                    .eq('code', code)
                    .single();

                if (quizError || !quiz) {
                    alert('❌ Kode kuis tidak ditemukan!');
                    return;
                }

                // Check if student's class matches quiz class
                if (quiz.class && quiz.class !== gameState.currentUser.class) {
                    alert(`❌ Kuis ini khusus untuk kelas ${quiz.class}!\nAnda terdaftar di kelas ${gameState.currentUser.class}.`);
                    return;
                }

                // Check if user already registered for this quiz
                const { data: existingParticipant } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', quiz.id)
                    .eq('nis', gameState.currentUser.nis)
                    .single();

                if (existingParticipant) {
                    alert('❌ Anda sudah terdaftar untuk kuis ini!');
                    return;
                }

                // Add participant using logged in user data
                const { data: participant, error: participantError } = await supabase
                    .from('participants')
                    .insert([{
                        quiz_id: quiz.id,
                        name: gameState.currentUser.name,
                        nis: gameState.currentUser.nis,
                        class: gameState.currentUser.class,
                        score: 0
                    }])
                    .select()
                    .single();

                if (participantError) throw participantError;

                gameState.currentQuiz = quiz;
                gameState.currentParticipant = participant;
                
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                showScreen('lobbyScreen');
                await loadParticipants();
                
                if (quiz.status === 'active') {
                    startGameFromDatabase();
                }
                
            } catch (error) {
                console.error('Error joining game:', error);
                alert('❌ Gagal bergabung: ' + error.message);
            }
        }

        // Load participants
        async function loadParticipants() {
            if (!gameState.currentQuiz) return;

            try {
                const { data: participants, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', gameState.currentQuiz.id)
                    .eq('is_active', true)
                    .order('joined_at');

                if (error) throw error;

                const participantsList = document.getElementById('participantsList');
                const participantCount = document.getElementById('participantCount');
                
                participantCount.textContent = participants.length;
                
                participantsList.innerHTML = participants.map(participant => `
                    <div class="bg-white/20 rounded-lg p-3 flex items-center animate-slide-in">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
                            ${participant.name.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-medium">${participant.name}</span>
                        ${participant.id === gameState.currentParticipant?.id ? '<span class="ml-auto text-yellow-400">👤</span>' : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }

        // Start quiz
        async function startQuiz() {
            try {
                const { error } = await supabase
                    .from('quizzes')
                    .update({ status: 'active' })
                    .eq('id', gameState.currentQuiz.id);

                if (error) throw error;
                
                alert('🚀 Kuis dimulai! Semua peserta akan otomatis masuk ke game.');
                
            } catch (error) {
                console.error('Error starting quiz:', error);
                alert('❌ Gagal memulai kuis: ' + error.message);
            }
        }

        // Start game from database
        async function startGameFromDatabase() {
            try {
                // Load questions
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('quiz_id', gameState.currentQuiz.id)
                    .order('order_number');

                if (error) throw error;

                // Shuffle questions for each participant
                gameState.questions = shuffleArray([...questions]);
                
                // Shuffle answer options for each question while preserving correct answer
                gameState.questions = gameState.questions.map(question => {
                    const shuffledQuestion = { ...question };
                    const originalOptions = [...question.options];
                    const correctOption = originalOptions[question.correct_answer];
                    
                    // Create array of indices and shuffle them
                    const indices = [0, 1, 2, 3];
                    const shuffledIndices = shuffleArray(indices);
                    
                    // Rearrange options based on shuffled indices
                    shuffledQuestion.options = shuffledIndices.map(index => originalOptions[index]);
                    
                    // Find new position of correct answer
                    shuffledQuestion.correct_answer = shuffledIndices.indexOf(question.correct_answer);
                    
                    return shuffledQuestion;
                });
                
                gameState.currentQuestionIndex = 0;
                gameState.score = 0;
                
                showScreen('gameScreen');
                loadCurrentQuestion();
                
            } catch (error) {
                console.error('Error starting game:', error);
                alert('❌ Gagal memulai game: ' + error.message);
            }
        }

        // Load current question
        function loadCurrentQuestion() {
            const question = gameState.questions[gameState.currentQuestionIndex];
            if (!question) return;

            document.getElementById('currentQuestion').textContent = gameState.currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = gameState.questions.length;
            document.getElementById('questionText').textContent = question.question_text;
            document.getElementById('currentScore').textContent = gameState.score;

            // Create answer options
            const answerOptions = document.getElementById('answerOptions');
            answerOptions.innerHTML = question.options.map((option, index) => `
                <button onclick="selectAnswer(${index})" class="answer-btn bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-6 px-6 rounded-xl text-lg transition-all duration-300 transform hover:scale-105">
                    ${String.fromCharCode(65 + index)}. ${option}
                </button>
            `).join('');

            // Start timer
            gameState.timeRemaining = gameState.currentQuiz.time_limit;
            startTimer();
        }

        // Select answer
        async function selectAnswer(selectedIndex) {
            clearInterval(gameState.timer);
            
            const question = gameState.questions[gameState.currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct_answer;
            
            if (isCorrect) {
                gameState.score += 100;
            }

            // Save answer to database
            try {
                await supabase
                    .from('quiz_answers')
                    .insert([{
                        quiz_id: gameState.currentQuiz.id,
                        participant_id: gameState.currentParticipant.id,
                        question_number: gameState.currentQuestionIndex + 1,
                        selected_answer: selectedIndex,
                        is_correct: isCorrect
                    }]);

                // Update participant score
                await supabase
                    .from('participants')
                    .update({ score: gameState.score })
                    .eq('id', gameState.currentParticipant.id);

            } catch (error) {
                console.error('Error saving answer:', error);
            }

            // Show result
            const answerButtons = document.querySelectorAll('.answer-btn');
            answerButtons.forEach(btn => btn.disabled = true);
            answerButtons[question.correct_answer].classList.add('ring-4', 'ring-green-400');
            
            if (selectedIndex !== question.correct_answer && selectedIndex >= 0) {
                answerButtons[selectedIndex].classList.add('ring-4', 'ring-red-400');
            }

            setTimeout(() => {
                // Next question or results
                gameState.currentQuestionIndex++;
                if (gameState.currentQuestionIndex < gameState.questions.length) {
                    loadCurrentQuestion();
                } else {
                    showResults();
                }
            }, 2000);
        }

        // Start timer
        function startTimer() {
            const timeLimit = gameState.currentQuiz.time_limit;
            gameState.timer = setInterval(() => {
                gameState.timeRemaining--;
                document.getElementById('timeRemaining').textContent = `⏰ ${gameState.timeRemaining}`;
                
                const percentage = (gameState.timeRemaining / timeLimit) * 100;
                document.getElementById('timerBar').style.width = percentage + '%';
                
                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timer);
                    selectAnswer(-1); // Time's up
                }
            }, 1000);
        }

        // Show results
        async function showResults() {
            try {
                // Get final leaderboard
                const { data: participants, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', gameState.currentQuiz.id)
                    .order('score', { ascending: false });

                if (error) throw error;

                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = participants.map((participant, index) => {
                    const medals = ['🥇', '🥈', '🥉'];
                    const medal = medals[index] || '🏅';
                    
                    return `
                        <div class="bg-white/20 rounded-lg p-4 flex items-center justify-between animate-slide-in ${participant.id === gameState.currentParticipant?.id ? 'ring-2 ring-yellow-400' : ''}">
                            <div class="flex items-center">
                                <span class="text-2xl mr-4">${medal}</span>
                                <div>
                                    <div class="text-white font-bold text-lg">${participant.name}</div>
                                    <div class="text-white/60">Peringkat ${index + 1}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-400 font-bold text-xl">${participant.score}</div>
                                <div class="text-white/60">poin</div>
                            </div>
                        </div>
                    `;
                }).join('');

                showScreen('resultsScreen');
                
            } catch (error) {
                console.error('Error loading results:', error);
                alert('❌ Gagal memuat hasil: ' + error.message);
            }
        }

        // Utility functions
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Shuffle array using Fisher-Yates algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showScreen(screenName) {
            const screens = ['loginScreen', 'registerScreen', 'welcomeScreen', 'lobbyScreen', 'gameScreen', 'resultsScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenName).classList.remove('hidden');
            gameState.currentScreen = screenName;
        }

        function toggleAdminPanel() {
            console.log('Admin panel clicked'); // Debug log
            
            // Check if admin panel is already open
            const adminPanel = document.getElementById('adminPanel');
            if (!adminPanel.classList.contains('hidden')) {
                closeAdminPanel();
                return;
            }
            
            // Show password dialog
            showAdminPasswordDialog();
        }

        function showAdminPasswordDialog() {
            // Create password dialog
            const dialog = document.createElement('div');
            dialog.id = 'adminPasswordDialog';
            dialog.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            dialog.innerHTML = `
                <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-md w-full border border-white/20">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">🔐</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Panel Admin Guru</h3>
                        <p class="text-white/70">Masukkan password untuk mengakses</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <input type="password" id="adminPassword" placeholder="Password admin..." 
                                   class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center"
                                   onkeypress="if(event.key==='Enter') checkAdminPassword()">
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="closeAdminPasswordDialog()" 
                                    class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                Batal
                            </button>
                            <button onclick="checkAdminPassword()" 
                                    class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                Masuk
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <p class="text-white/60 text-sm">💡 Password: <code class="bg-white/20 px-2 py-1 rounded">guruhebat2025</code></p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // Focus on password input
            setTimeout(() => {
                document.getElementById('adminPassword').focus();
            }, 100);
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'guruhebat2025') {
                closeAdminPasswordDialog();
                document.getElementById('adminPanel').classList.remove('hidden');
                refreshStats();
                alert('✅ Selamat datang di Panel Admin!');
            } else {
                alert('❌ Password salah! Coba lagi.');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        function closeAdminPasswordDialog() {
            const dialog = document.getElementById('adminPasswordDialog');
            if (dialog) {
                dialog.remove();
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        async function refreshStats() {
            try {
                const { data: savedQuizzes } = await supabase.from('quizzes').select('id');
                const { data: participants } = await supabase.from('participants').select('id').eq('is_active', true);
                
                document.getElementById('savedQuizCount').textContent = savedQuizzes?.length || 0;
                document.getElementById('totalParticipants').textContent = participants?.length || 0;
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        // Show quiz library
        async function showQuizLibrary() {
            document.getElementById('quizLibrary').classList.remove('hidden');
            await loadQuizLibrary();
        }

        // Close quiz library
        function closeQuizLibrary() {
            document.getElementById('quizLibrary').classList.add('hidden');
        }

        // Load quiz library
        async function loadQuizLibrary() {
            try {
                const { data: quizzes, error } = await supabase
                    .from('quizzes')
                    .select(`
                        *,
                        participants(count)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                quizLibrary.allQuizzes = quizzes || [];
                quizLibrary.filteredQuizzes = [...quizLibrary.allQuizzes];
                
                renderQuizLibrary();
                
            } catch (error) {
                console.error('Error loading quiz library:', error);
                alert('❌ Gagal memuat library kuis: ' + error.message);
            }
        }

        // Filter quizzes
        function filterQuizzes() {
            const searchTerm = document.getElementById('searchQuiz').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // Filter by search term and status
            quizLibrary.filteredQuizzes = quizLibrary.allQuizzes.filter(quiz => {
                const matchesSearch = quiz.title.toLowerCase().includes(searchTerm) || 
                                    quiz.creator_name.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || quiz.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });

            // Sort quizzes
            quizLibrary.filteredQuizzes.sort((a, b) => {
                switch (sortOrder) {
                    case 'oldest':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'name':
                        return a.title.localeCompare(b.title);
                    case 'participants':
                        return (b.participants?.length || 0) - (a.participants?.length || 0);
                    case 'newest':
                    default:
                        return new Date(b.created_at) - new Date(a.created_at);
                }
            });

            renderQuizLibrary();
        }

        // Render quiz library
        function renderQuizLibrary() {
            const quizList = document.getElementById('quizList');
            const emptyState = document.getElementById('emptyState');

            if (quizLibrary.filteredQuizzes.length === 0) {
                quizList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            quizList.innerHTML = quizLibrary.filteredQuizzes.map(quiz => {
                const statusColors = {
                    waiting: 'from-yellow-500/20 to-orange-500/20 border-yellow-500/30',
                    active: 'from-green-500/20 to-teal-500/20 border-green-500/30',
                    completed: 'from-gray-500/20 to-slate-500/20 border-gray-500/30'
                };

                const statusIcons = {
                    waiting: '⏳',
                    active: '🟢',
                    completed: '✅'
                };

                const statusTexts = {
                    waiting: 'Menunggu',
                    active: 'Aktif',
                    completed: 'Selesai'
                };

                const participantCount = quiz.participants?.length || 0;
                const createdDate = new Date(quiz.created_at).toLocaleDateString('id-ID');

                return `
                    <div class="bg-gradient-to-br ${statusColors[quiz.status]} rounded-2xl p-6 border transition-all duration-300 hover:scale-105">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-2">${statusIcons[quiz.status]}</span>
                                <span class="text-white/80 text-sm">${statusTexts[quiz.status]}</span>
                            </div>
                            <span class="text-white/60 text-xs">${createdDate}</span>
                        </div>
                        
                        <h3 class="text-white font-bold text-lg mb-2 line-clamp-2">${quiz.title}</h3>
                        <p class="text-white/70 text-sm mb-4">👩‍🏫 ${quiz.creator_name}</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-white/10 rounded-lg p-3 text-center">
                                <div class="text-white font-bold text-lg">${quiz.question_count}</div>
                                <div class="text-white/60 text-xs">Soal</div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3 text-center">
                                <div class="text-white font-bold text-lg">${participantCount}</div>
                                <div class="text-white/60 text-xs">Peserta</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            ${quiz.status === 'waiting' ? `
                                <button onclick="playQuizFromLibrary('${quiz.id}')" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 text-sm">
                                    🚀 Mainkan Kuis
                                </button>
                            ` : quiz.status === 'active' ? `
                                <button onclick="hostQuiz('${quiz.id}')" 
                                  class="w-full bg-gradient-to-r from-green-600 to-teal-700 hover:from-green-700 hover:to-teal-800 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 text-sm">
                                  📡 Host Quiz (${quiz.code})
                                </button>
                            ` : `
                                <button onclick="viewQuizResults('${quiz.id}')" class="w-full bg-gradient-to-r from-gray-500 to-slate-600 hover:from-gray-600 hover:to-slate-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 text-sm">
                                    📊 Lihat Hasil
                                </button>
                            `}
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="duplicateQuiz('${quiz.id}')" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-2 px-3 rounded-lg transition-all duration-300 text-xs">
                                    📋 Duplikat
                                </button>
                                <button onclick="deleteQuiz('${quiz.id}')" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-2 px-3 rounded-lg transition-all duration-300 text-xs">
                                    🗑️ Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Play quiz from library
        async function playQuizFromLibrary(quizId) {
            try {
                const { data: quiz, error } = await supabase
                    .from('quizzes')
                    .select('*')
                    .eq('id', quizId)
                    .single();

                if (error) throw error;

                if (quiz.status !== 'waiting') {
                    alert('❌ Kuis ini sudah tidak bisa dimainkan!');
                    return;
                }

                // Generate new code for this session
                const newCode = generateGameCode();
                
                const { error: updateError } = await supabase
                    .from('quizzes')
                    .update({ 
                        code: newCode,
                        status: 'waiting'
                    })
                    .eq('id', quizId);

                if (updateError) throw updateError;

                gameState.currentQuiz = { ...quiz, code: newCode };
                document.getElementById('codeDisplay').textContent = newCode;
                document.getElementById('gameCode').classList.remove('hidden');
                
                closeQuizLibrary();
                closeAdminPanel();
                
                alert(`🚀 Kuis "${quiz.title}" siap dimainkan!\nKode Baru: ${newCode}\nBagikan kode ini ke siswa.`);
                
                await startQuiz();
                
            } catch (error) {
                console.error('Error playing quiz from library:', error);
                alert('❌ Gagal memainkan kuis: ' + error.message);
            }
        }

        // Join active quiz
        function joinActiveQuiz(code) {
            document.getElementById('joinCode').value = code;
            closeQuizLibrary();
            closeAdminPanel();
            alert(`💡 Kode kuis "${code}" sudah diisi!\nMasukkan nama Anda dan klik "Gabung Kuis Sekarang".`);
        }

        // View quiz results
        async function viewQuizResults(quizId) {
            try {
                const { data: participants, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', quizId)
                    .order('score', { ascending: false });

                if (error) throw error;

                const quiz = quizLibrary.allQuizzes.find(q => q.id === quizId);
                
                let resultsText = `📊 Hasil Kuis: ${quiz.title}\n\n🏆 Peringkat:\n`;
                participants.forEach((participant, index) => {
                    const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏅';
                    resultsText += `${medal} ${participant.name}: ${participant.score} poin\n`;
                });

                alert(resultsText);
                
            } catch (error) {
                console.error('Error viewing quiz results:', error);
                alert('❌ Gagal memuat hasil kuis: ' + error.message);
            }
        }

        // Duplicate quiz
        async function duplicateQuiz(quizId) {
            if (!confirm('Duplikat kuis ini? Akan dibuat salinan baru dengan nama "[COPY] ..."')) return;

            try {
                // Get original quiz
                const { data: originalQuiz, error: quizError } = await supabase
                    .from('quizzes')
                    .select('*')
                    .eq('id', quizId)
                    .single();

                if (quizError) throw quizError;

                // Get original questions
                const { data: originalQuestions, error: questionsError } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('quiz_id', quizId)
                    .order('order_number');

                if (questionsError) throw questionsError;

                // Create new quiz
                const { data: newQuiz, error: newQuizError } = await supabase
                    .from('quizzes')
                    .insert([{
                        title: `[COPY] ${originalQuiz.title}`,
                        code: generateGameCode(),
                        creator_name: originalQuiz.creator_name,
                        question_count: originalQuiz.question_count,
                        time_limit: originalQuiz.time_limit,
                        status: 'waiting'
                    }])
                    .select()
                    .single();

                if (newQuizError) throw newQuizError;

                // Copy questions
                const questionsToInsert = originalQuestions.map(q => ({
                    quiz_id: newQuiz.id,
                    question_text: q.question_text,
                    options: q.options,
                    correct_answer: q.correct_answer,
                    order_number: q.order_number
                }));

                const { error: insertQuestionsError } = await supabase
                    .from('questions')
                    .insert(questionsToInsert);

                if (insertQuestionsError) throw insertQuestionsError;

                alert(`✅ Kuis berhasil diduplikat!\nNama: ${newQuiz.title}\nKode: ${newQuiz.code}`);
                
                await loadQuizLibrary();
                
            } catch (error) {
                console.error('Error duplicating quiz:', error);
                alert('❌ Gagal menduplikat kuis: ' + error.message);
            }
        }

        // Delete quiz
        async function deleteQuiz(quizId) {
            const quiz = quizLibrary.allQuizzes.find(q => q.id === quizId);
            
            if (!confirm(`Hapus kuis "${quiz.title}"?\nTindakan ini tidak dapat dibatalkan!`)) return;

            try {
                // Delete questions first (foreign key constraint)
                const { error: questionsError } = await supabase
                    .from('questions')
                    .delete()
                    .eq('quiz_id', quizId);

                if (questionsError) throw questionsError;

                // Delete participants
                const { error: participantsError } = await supabase
                    .from('participants')
                    .delete()
                    .eq('quiz_id', quizId);

                if (participantsError) throw participantsError;

                // Delete quiz answers
                const { error: answersError } = await supabase
                    .from('quiz_answers')
                    .delete()
                    .eq('quiz_id', quizId);

                if (answersError) throw answersError;

                // Delete quiz
                const { error: quizError } = await supabase
                    .from('quizzes')
                    .delete()
                    .eq('id', quizId);

                if (quizError) throw quizError;

                alert(`✅ Kuis "${quiz.title}" berhasil dihapus!`);
                
                await loadQuizLibrary();
                await refreshStats();
                
            } catch (error) {
                console.error('Error deleting quiz:', error);
                alert('❌ Gagal menghapus kuis: ' + error.message);
            }
        }
async function hostQuiz(quizId) {
  try {
    // Ubah status kuis jadi "waiting"
    const { error } = await supabase
      .from("quizzes")
      .update({ status: "waiting" })
      .eq("id", quizId);

    if (error) {
      console.error("❌ Gagal host quiz:", error);
      alert("Gagal meng-host kuis.");
      return;
    }

    // Tampilkan panel monitoring guru
    openMonitoringPanel(quizId);

    alert("✅ Quiz berhasil di-host. Siswa bisa join dengan kode kuis!");
  } catch (err) {
    console.error(err);
    alert("Terjadi error saat host quiz.");
  }
}

        // Show monitoring panel
        async function showMonitoringPanel() {
            document.getElementById('monitoringPanel').classList.remove('hidden');
            await loadMonitoringData();
        }

        // Close monitoring panel
        function closeMonitoringPanel() {
            document.getElementById('monitoringPanel').classList.add('hidden');
        }

        // Load monitoring data
        async function loadMonitoringData() {
            try {
                // Get current active quiz
                const { data: activeQuiz } = await supabase
                    .from('quizzes')
                    .select('*')
                    .eq('status', 'waiting')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (activeQuiz) {
                    gameState.currentQuiz = activeQuiz;
                    document.getElementById('monitorQuizTitle').textContent = activeQuiz.title;
                    document.getElementById('monitorQuizCode').textContent = `Kode: ${activeQuiz.code}`;
                    document.getElementById('monitorQuizClass').textContent = activeQuiz.class || '-';
                    document.getElementById('monitorQuizSubject').textContent = activeQuiz.subject || '-';
                    
                    // Load participants for this quiz
                    await loadLiveParticipants();
                    
                    // Enable start button if there are participants
                    const participantCount = parseInt(document.getElementById('liveParticipantCount').textContent);
                    document.getElementById('startQuizBtn').disabled = participantCount === 0;
                } else {
                    document.getElementById('monitorQuizTitle').textContent = 'Tidak Ada Kuis Aktif';
                    document.getElementById('monitorQuizCode').textContent = '-';
                    document.getElementById('monitorQuizClass').textContent = '-';
                    document.getElementById('monitorQuizSubject').textContent = '-';
                    document.getElementById('liveParticipantCount').textContent = '0';
                    document.getElementById('startQuizBtn').disabled = true;
                }
                
            } catch (error) {
                console.error('Error loading monitoring data:', error);
            }
        }

        // Load live participants
        async function loadLiveParticipants() {
            if (!gameState.currentQuiz) return;

            try {
                const { data: participants, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', gameState.currentQuiz.id)
                    .eq('is_active', true)
                    .order('joined_at');

                if (error) throw error;

                const participantsList = document.getElementById('liveParticipantsList');
                const participantCount = document.getElementById('liveParticipantCount');
                const monitorCount = document.getElementById('monitorParticipantCount');
                
                participantCount.textContent = participants.length;
                monitorCount.textContent = participants.length;
                
                if (participants.length === 0) {
                    participantsList.innerHTML = `
                        <div class="text-white/60 text-center py-8 col-span-full">
                            Belum ada peserta yang bergabung
                        </div>
                    `;
                } else {
                    participantsList.innerHTML = participants.map(participant => `
                        <div class="bg-white/20 rounded-lg p-4 animate-slide-in">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
                                    ${participant.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="flex-1">
                                    <div class="text-white font-bold text-sm">${participant.name}</div>
                                    <div class="text-white/60 text-xs">NIS: ${participant.nis}</div>
                                </div>
                            </div>
                            <div class="text-center">
                                <span class="bg-white/20 px-2 py-1 rounded text-white/80 text-xs">${participant.class}</span>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Update start button state
                document.getElementById('startQuizBtn').disabled = participants.length === 0;
                
            } catch (error) {
                console.error('Error loading live participants:', error);
            }
        }

        // Start active quiz
        async function startActiveQuiz() {
            if (!gameState.currentQuiz) return;
            
            const participantCount = parseInt(document.getElementById('liveParticipantCount').textContent);
            if (participantCount === 0) {
                alert('❌ Belum ada peserta yang bergabung!');
                return;
            }

            if (confirm(`🚀 Mulai kuis "${gameState.currentQuiz.title}" untuk ${participantCount} peserta?`)) {
                await startQuiz();
                closeMonitoringPanel();
                alert('✅ Kuis telah dimulai! Semua peserta akan otomatis masuk ke game.');
            }
        }

        // Show results manager
        async function showResultsManager() {
            document.getElementById('resultsManager').classList.remove('hidden');
            await loadResultsData();
        }

        // Close results manager
        function closeResultsManager() {
            document.getElementById('resultsManager').classList.add('hidden');
        }

        // Load results data
        async function loadResultsData() {
            try {
                const { data: quizzes, error } = await supabase
                    .from('quizzes')
                    .select(`
                        *,
                        participants(*)
                    `)
                    .eq('status', 'completed')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                resultsManager.allResults = quizzes || [];
                resultsManager.filteredResults = [...resultsManager.allResults];
                
                renderResultsList();
                
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        // Filter results
        function filterResults() {
            const searchTerm = document.getElementById('searchResults').value.toLowerCase();
            const classFilter = document.getElementById('filterClass').value;
            const subjectFilter = document.getElementById('filterSubject').value;
            const periodFilter = document.getElementById('filterPeriod').value;

            resultsManager.filteredResults = resultsManager.allResults.filter(quiz => {
                const matchesSearch = quiz.title.toLowerCase().includes(searchTerm);
                const matchesClass = !classFilter || quiz.class === classFilter;
                const matchesSubject = !subjectFilter || quiz.subject === subjectFilter;
                
                let matchesPeriod = true;
                if (periodFilter) {
                    const quizDate = new Date(quiz.created_at);
                    const now = new Date();
                    
                    switch (periodFilter) {
                        case 'today':
                            matchesPeriod = quizDate.toDateString() === now.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matchesPeriod = quizDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            matchesPeriod = quizDate >= monthAgo;
                            break;
                    }
                }
                
                return matchesSearch && matchesClass && matchesSubject && matchesPeriod;
            });

            renderResultsList();
        }

        // Render results list
        function renderResultsList() {
            const resultsList = document.getElementById('resultsList');
            const emptyState = document.getElementById('resultsEmptyState');

            if (resultsManager.filteredResults.length === 0) {
                resultsList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            resultsList.innerHTML = resultsManager.filteredResults.map(quiz => {
                const participantCount = quiz.participants?.length || 0;
                const avgScore = participantCount > 0 
                    ? Math.round(quiz.participants.reduce((sum, p) => sum + p.score, 0) / participantCount)
                    : 0;
                const completedDate = new Date(quiz.created_at).toLocaleDateString('id-ID');

                return `
                    <div class="bg-gradient-to-br from-purple-500/20 to-blue-500/20 rounded-2xl p-6 border border-white/30">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-white font-bold text-lg mb-1">${quiz.title}</h3>
                                <p class="text-white/70 text-sm">👩‍🏫 ${quiz.creator_name} • 📅 ${completedDate}</p>
                                <div class="flex items-center space-x-4 mt-2">
                                    <span class="bg-white/20 px-2 py-1 rounded text-white/80 text-xs">📚 ${quiz.class}</span>
                                    <span class="bg-white/20 px-2 py-1 rounded text-white/80 text-xs">📖 ${quiz.subject}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-white font-bold text-xl">${participantCount}</div>
                                <div class="text-white/60 text-sm">Peserta</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-white/10 rounded-lg p-3 text-center">
                                <div class="text-white font-bold">${quiz.question_count}</div>
                                <div class="text-white/60 text-xs">Soal</div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3 text-center">
                                <div class="text-white font-bold">${avgScore}</div>
                                <div class="text-white/60 text-xs">Rata-rata</div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-3 text-center">
                                <div class="text-white font-bold">${quiz.time_limit}s</div>
                                <div class="text-white/60 text-xs">Per Soal</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="viewDetailedResults('${quiz.id}')" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 text-sm">
                                👁️ Lihat Detail
                            </button>
                            <button onclick="exportResults('${quiz.id}')" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 text-sm">
                                📊 Export Excel
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View detailed results
        async function viewDetailedResults(quizId) {
            try {
                const { data: participants, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', quizId)
                    .order('score', { ascending: false });

                if (error) throw error;

                const quiz = resultsManager.allResults.find(q => q.id === quizId);
                
                let resultsText = `📊 Hasil Detail: ${quiz.title}\n`;
                resultsText += `📚 Kelas: ${quiz.class} | 📖 ${quiz.subject}\n`;
                resultsText += `👩‍🏫 Guru: ${quiz.creator_name}\n\n`;
                resultsText += `🏆 Peringkat Lengkap:\n`;
                
                participants.forEach((participant, index) => {
                    const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                    resultsText += `${medal} ${participant.name} (${participant.nis}) - ${participant.score} poin\n`;
                });

                alert(resultsText);
                
            } catch (error) {
                console.error('Error viewing detailed results:', error);
                alert('❌ Gagal memuat detail hasil: ' + error.message);
            }
        }

        // Export results to Excel
        async function exportResults(quizId) {
            try {
                const { data: participants, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', quizId)
                    .order('score', { ascending: false });

                if (error) throw error;

                const quiz = resultsManager.allResults.find(q => q.id === quizId);
                
                // Prepare data for Excel
                const excelData = [
                    ['Hasil Kuis: ' + quiz.title],
                    ['Kelas: ' + quiz.class, 'Mata Pelajaran: ' + quiz.subject],
                    ['Guru: ' + quiz.creator_name, 'Tanggal: ' + new Date(quiz.created_at).toLocaleDateString('id-ID')],
                    [], // Empty row
                    ['Peringkat', 'NIS', 'Nama Lengkap', 'Kelas', 'Skor', 'Persentase']
                ];

                participants.forEach((participant, index) => {
                    const percentage = Math.round((participant.score / (quiz.question_count * 100)) * 100);
                    excelData.push([
                        index + 1,
                        participant.nis,
                        participant.name,
                        participant.class,
                        participant.score,
                        percentage + '%'
                    ]);
                });

                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Set column widths
                ws['!cols'] = [
                    { width: 10 }, // Peringkat
                    { width: 15 }, // NIS
                    { width: 25 }, // Nama
                    { width: 10 }, // Kelas
                    { width: 10 }, // Skor
                    { width: 12 }  // Persentase
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Hasil Kuis');
                
                // Download file
                const fileName = `Hasil_${quiz.title.replace(/[^a-zA-Z0-9]/g, '_')}_${quiz.class}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('✅ Hasil kuis berhasil diexport ke Excel!');
                
            } catch (error) {
                console.error('Error exporting results:', error);
                alert('❌ Gagal export hasil: ' + error.message);
            }
        }

        // Initialize results manager state
        let resultsManager = {
            allResults: [],
            filteredResults: []
        };

        function backToHome() {
            const currentUser = gameState.currentUser; // Preserve user session
            
            gameState = {
                currentScreen: 'welcome',
                currentQuiz: null,
                currentParticipant: null,
                currentUser: currentUser, // Keep user logged in
                currentQuestionIndex: 0,
                score: 0,
                timeRemaining: 15,
                timer: null,
                questions: []
            };
            
            document.getElementById('gameCode').classList.add('hidden');
            document.getElementById('joinCode').value = '';
            
            if (currentUser) {
                showScreen('welcomeScreen');
            } else {
                showScreen('loginScreen');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9893affd667e6034',t:'MTc1OTU3MDUwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
