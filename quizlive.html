<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizLive - Game Kuis Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { box-sizing: border-box; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        .timer-bar { transition: width 1s linear; }
        
        /* Admin Panel Styles */
        .admin-nav-btn.active {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .admin-nav-btn.active:hover {
            background-color: #dbeafe;
        }
        .admin-sidebar-collapsed {
            width: 70px !important;
        }
        .admin-sidebar-collapsed .sidebar-text {
            display: none !important;
        }
        .admin-sidebar-collapsed .sidebar-stats {
            display: none !important;
        }
        .admin-main-expanded {
            margin-left: 70px !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-teal-500 min-h-screen">
    <!-- Header -->
    <div class="bg-white/10 backdrop-blur-sm border-b border-white/20">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-white flex items-center cursor-pointer hover:text-yellow-300 transition-colors" onclick="toggleAdminPanel()">
                    <i class="fas fa-bullseye mr-2"></i> QuizLive
                </h1>
                <div id="gameCode" class="bg-white/20 px-4 py-2 rounded-lg text-white font-mono text-lg hidden">
                    Kode: <span id="codeDisplay">ABC123</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Login Screen -->
        <div id="loginScreen" class="text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-md mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-lock text-blue-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Masuk ke QuizLive</h2>
                <p class="text-xl text-white/80 mb-8">Login untuk mengikuti kuis</p>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">NIS (Nomor Induk)</label>
                        <input type="text" id="loginNIS" placeholder="Masukkan NIS Anda" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Password</label>
                        <input type="password" id="loginPassword" placeholder="Masukkan password" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    
                    <button onclick="loginUser()" id="loginBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                        <span id="loginBtnText"><i class="fas fa-rocket mr-2"></i>Masuk</span>
                        <span id="loginBtnLoading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Masuk...
                        </span>
                    </button>
                    
                    <div class="text-center">
                        <p class="text-white/70 mb-4">Belum punya akun?</p>
                        <button onclick="showRegisterScreen()" class="text-yellow-400 hover:text-yellow-300 font-bold underline transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Daftar Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="hidden text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-lg mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-user-plus text-green-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Daftar Akun Baru</h2>
                <p class="text-xl text-white/80 mb-8">Buat akun untuk mengikuti kuis</p>
                
                <div class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">NIS (Nomor Induk)</label>
                            <input type="text" id="registerNIS" placeholder="Contoh: 2024001" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                        </div>
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">Kelas</label>
                            <select id="registerClass" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50" style="background-color: rgba(255,255,255,0.2) !important; color: white !important;">
                                <option value="" style="background-color: #1f2937; color: white;">Pilih Kelas</option>
                                <option value="4A" style="background-color: #1f2937; color: white;">4A</option>
                                <option value="4B" style="background-color: #1f2937; color: white;">4B</option>
                                <option value="5A" style="background-color: #1f2937; color: white;">5A</option>
                                <option value="5B" style="background-color: #1f2937; color: white;">5B</option>
                                <option value="6A" style="background-color: #1f2937; color: white;">6A</option>
                                <option value="6B" style="background-color: #1f2937; color: white;">6B</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Nama Lengkap</label>
                        <input type="text" id="registerName" placeholder="Masukkan nama lengkap" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Password</label>
                        <input type="password" id="registerPassword" placeholder="Buat password (min. 6 karakter)" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Konfirmasi Password</label>
                        <input type="password" id="confirmPassword" placeholder="Ulangi password" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    
                    <button onclick="registerUser()" id="registerBtn" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                        <span id="registerBtnText"><i class="fas fa-user-plus mr-2"></i>Daftar Akun</span>
                        <span id="registerBtnLoading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Mendaftar...
                        </span>
                    </button>
                    
                    <div class="text-center">
                        <p class="text-white/70 mb-4">Sudah punya akun?</p>
                        <button onclick="showLoginScreen()" class="text-yellow-400 hover:text-yellow-300 font-bold underline transition-colors">
                            <i class="fas fa-sign-in-alt mr-2"></i>Masuk Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Welcome Screen (After Login) -->
        <div id="welcomeScreen" class="hidden text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-2xl mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-graduation-cap text-yellow-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Selamat Datang, <span id="welcomeUserName">Siswa</span>!</h2>
                <p class="text-xl text-white/80 mb-8">Siap mengikuti kuis hari ini?</p>
                
                <div class="bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-2xl p-8 border border-white/30 mb-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">Kode Kuis</label>
                            <input type="text" id="joinCode" placeholder="Contoh: ABC123" class="w-full px-6 py-4 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center text-2xl font-mono tracking-widest uppercase">
                        </div>
                        <button onclick="joinGame()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-rocket mr-2"></i>Gabung Kuis
                        </button>
                        
                        <div class="pt-4 border-t border-white/20">
                            <button onclick="logoutUser()" class="text-white/70 hover:text-white transition-colors underline">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden fixed inset-0 z-50">
            <!-- Sidebar -->
            <div id="adminSidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-xl transition-all duration-300 ease-in-out overflow-y-auto">
                <!-- Header -->
                <div class="bg-white border-b border-gray-200 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-chalkboard-teacher text-blue-500 text-xl mr-2"></i>
                            <div class="sidebar-text">
                                <h2 class="text-lg font-bold text-gray-800">Panel Admin</h2>
                                <p class="text-gray-600 text-xs">Kelola Kuis & Monitoring</p>
                            </div>
                        </div>
                        <button onclick="toggleAdminSidebar()" class="text-gray-500 hover:text-gray-700 transition-colors p-1 rounded">
                            <i class="fas fa-chevron-left text-sm"></i>
                        </button>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <div class="p-3">
                    <nav class="space-y-1">
                        <button onclick="showAdminSection('createQuiz')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-plus-circle text-green-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Buat Kuis Baru</span>
                        </button>
                        
                        <button onclick="showAdminSection('quizLibrary')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-book text-blue-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Library Kuis</span>
                        </button>
                        
                        <button onclick="showAdminSection('monitoring')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-chart-line text-orange-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Monitoring Live</span>
                        </button>
                        
                        <button onclick="showAdminSection('results')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-clipboard-list text-purple-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Kelola Hasil</span>
                        </button>
                        
                        <button onclick="showAdminSection('stats')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-chart-bar text-teal-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Statistik</span>
                        </button>
                    </nav>
                </div>

                <!-- Footer Buttons -->
                <div class="absolute bottom-0 left-0 right-0 p-3 border-t border-gray-200 bg-white">
                    <div class="space-y-2">
                        <button onclick="refreshSidebarStats()" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-sync-alt text-gray-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Refresh</span>
                        </button>
                        
                        <button onclick="closeAdminPanel()" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-times text-red-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Tutup Panel</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="adminMainContent" class="ml-64 min-h-screen bg-gray-50 transition-all duration-300">
                <!-- Create Quiz Section -->
                <div id="adminCreateQuiz" class="admin-section p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center mb-6">
                                <i class="fas fa-plus-circle text-green-500 text-xl mr-3"></i>
                                <h2 class="text-xl font-bold text-gray-800">Buat Kuis Baru</h2>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- Quiz Info Form -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Nama Kuis</label>
                                        <input type="text" id="quizName" placeholder="Contoh: Kuis Matematika Kelas 7" class="w-full px-3 py-2 bg-white text-gray-800 placeholder-gray-500 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Mata Pelajaran</label>
                                            <select id="quizSubject" class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="">Pilih Mapel</option>
                                                <option value="Matematika">Matematika</option>
                                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                                <option value="IPA">IPA</option>
                                                <option value="IPS">IPS</option>
                                                <option value="PKN">PKN</option>
                                                <option value="Agama">Agama</option>
                                                <option value="Seni Budaya">Seni Budaya</option>
                                                <option value="PJOK">PJOK</option>
                                                <option value="Prakarya">Prakarya</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Kelas</label>
                                            <select id="quizClass" class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="">Pilih Kelas</option>
                                                <option value="4A">4A</option>
                                                <option value="4B">4B</option>
                                                <option value="5A">5A</option>
                                                <option value="5B">5B</option>
                                                <option value="6A">6A</option>
                                                <option value="6B">6B</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Nama Guru</label>
                                            <input type="text" id="teacherName" placeholder="Nama Anda" class="w-full px-3 py-2 bg-white text-gray-800 placeholder-gray-500 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Waktu per Soal</label>
                                            <select id="adminTimeLimit" class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="10">10 detik</option>
                                                <option value="15" selected>15 detik</option>
                                                <option value="30">30 detik</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="space-y-3">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Pilih Metode Pembuatan</h3>
                                    
                                    <button onclick="showQuestionBuilder()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                                        <i class="fas fa-edit mr-2"></i>Buat Soal Sendiri
                                    </button>
                                    
                                    <button onclick="showExcelImport()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                                        <i class="fas fa-file-excel mr-2"></i>Import dari Excel
                                    </button>
                                    
                                    <button onclick="createQuizWithSamples()" class="w-full bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                                        <i class="fas fa-rocket mr-2"></i>Pakai Contoh Soal
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other admin sections... -->
                <div id="adminQuizLibrary" class="admin-section hidden p-6">
                    <!-- Quiz Library content -->
                </div>
                <div id="adminMonitoring" class="admin-section hidden p-6">
                    <!-- Monitoring content -->
                </div>
                <div id="adminResults" class="admin-section hidden p-6">
                    <!-- Results content -->
                </div>
                <div id="adminStats" class="admin-section hidden p-6">
                    <!-- Stats content -->
                </div>
            </div>

            <!-- Collapsed Sidebar Toggle -->
            <div id="adminSidebarToggle" class="hidden fixed left-0 top-1/2 transform -translate-y-1/2 z-60">
                <button onclick="toggleAdminSidebar()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-r-lg shadow-lg transition-colors">
                    <i class="fas fa-chevron-right text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Other screens (Lobby, Game, Results) -->
        <div id="lobbyScreen" class="hidden">
            <!-- Lobby content -->
        </div>
        
        <div id="gameScreen" class="hidden">
            <!-- Game content -->
        </div>
        
        <div id="resultsScreen" class="hidden">
            <!-- Results content -->
        </div>
    </div>

    <script>
        // Kredensial Supabase
        const SUPABASE_URL = 'https://lglhmbdsldqlcjnkampd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnbGhtYmRzbGRxbGNqbmthbXBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDc4NTgsImV4cCI6MjA3NTEyMzg1OH0.857DRQpbvcfSaVtNDkgBKvx2PYvEfmA8-mlPiiZ6Ib0';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Game State
        let gameState = {
            currentScreen: 'login',
            currentQuiz: null,
            currentParticipant: null,
            currentUser: null,
            currentQuestionIndex: 0,
            score: 0,
            timeRemaining: 15,
            timer: null,
            questions: []
        };

        // Initialize app - YANG INI HARUS DIPERBAIKI
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - showing login screen');
            showScreen('loginScreen'); // PASTIKAN INI DIPANGGIL
            setupRealtimeSubscriptions();
            checkUserSession();
        });

        // FUNCTION YANG PERLU DITAMBAHKAN - showScreen()
        function showScreen(screenName) {
            console.log('Showing screen:', screenName);
            
            // Semua screens
            const screens = [
                'loginScreen', 
                'registerScreen', 
                'welcomeScreen', 
                'lobbyScreen', 
                'gameScreen', 
                'resultsScreen'
            ];
            
            // Sembunyikan semua screens
            screens.forEach(screen => {
                const element = document.getElementById(screen);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // Tampilkan screen yang dipilih
            const targetScreen = document.getElementById(screenName);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                gameState.currentScreen = screenName;
            } else {
                console.error('Screen not found:', screenName);
                // Fallback ke login screen
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }

        // FUNCTION YANG PERLU DITAMBAHKAN - showLoginScreen()
        function showLoginScreen() {
            document.getElementById('loginNIS').value = '';
            document.getElementById('loginPassword').value = '';
            showScreen('loginScreen');
        }

        // FUNCTION YANG PERLU DITAMBAHKAN - showRegisterScreen()
        function showRegisterScreen() {
            document.getElementById('registerNIS').value = '';
            document.getElementById('registerName').value = '';
            document.getElementById('registerClass').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            showScreen('registerScreen');
        }

        // Check if user is already logged in
        function checkUserSession() {
            const savedUser = localStorage.getItem('quizlive_user');
            if (savedUser) {
                try {
                    gameState.currentUser = JSON.parse(savedUser);
                    document.getElementById('welcomeUserName').textContent = gameState.currentUser.name;
                    showScreen('welcomeScreen');
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('quizlive_user');
                    showScreen('loginScreen');
                }
            } else {
                showScreen('loginScreen');
            }
        }

        // Register new user
        async function registerUser() {
            const nis = document.getElementById('registerNIS').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const studentClass = document.getElementById('registerClass').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validation
            if (!nis || !name || !studentClass || !password || !confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Data Tidak Lengkap',
                    text: 'Mohon lengkapi semua data yang diperlukan!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            if (password.length < 6) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Terlalu Pendek',
                    text: 'Password minimal harus 6 karakter!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            if (password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Tidak Cocok',
                    text: 'Konfirmasi password tidak sesuai dengan password yang dimasukkan!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading state
            const registerBtn = document.getElementById('registerBtn');
            const registerBtnText = document.getElementById('registerBtnText');
            const registerBtnLoading = document.getElementById('registerBtnLoading');
            
            registerBtn.disabled = true;
            registerBtnText.classList.add('hidden');
            registerBtnLoading.classList.remove('hidden');

            try {
                // Show processing notification
                Swal.fire({
                    title: 'Memproses Pendaftaran...',
                    text: 'Mohon tunggu sebentar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Check if NIS already exists
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('*')
                    .eq('nis', nis)
                    .single();

                if (existingUser) {
                    Swal.fire({
                        icon: 'error',
                        title: 'NIS Sudah Terdaftar',
                        text: 'NIS ini sudah digunakan. Gunakan NIS lain atau silakan login.',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }

                // Create new user
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([{
                        nis: nis,
                        name: name,
                        class: studentClass,
                        password: password
                    }])
                    .select()
                    .single();

                if (error) throw error;

                Swal.fire({
                    icon: 'success',
                    title: 'Pendaftaran Berhasil!',
                    text: `Akun untuk ${name} berhasil dibuat. Silakan login dengan NIS dan password Anda.`,
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    showLoginScreen();
                });

            } catch (error) {
                console.error('Registration error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Pendaftaran Gagal',
                    text: 'Terjadi kesalahan: ' + error.message,
                    confirmButtonColor: '#3b82f6'
                });
            } finally {
                // Reset button state
                registerBtn.disabled = false;
                registerBtnText.classList.remove('hidden');
                registerBtnLoading.classList.add('hidden');
            }
        }

        // Login user
        async function loginUser() {
            const nis = document.getElementById('loginNIS').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!nis || !password) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Belum Lengkap',
                    text: 'Mohon masukkan NIS dan password Anda!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading state
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginBtnLoading = document.getElementById('loginBtnLoading');
            
            loginBtn.disabled = true;
            loginBtnText.classList.add('hidden');
            loginBtnLoading.classList.remove('hidden');

            try {
                // Show processing notification
                Swal.fire({
                    title: 'Memproses Login...',
                    text: 'Mohon tunggu sebentar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('nis', nis)
                    .eq('password', password)
                    .single();

                if (error || !user) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Login Gagal',
                        text: 'NIS atau password yang Anda masukkan salah!',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }

                // Save user session
                gameState.currentUser = user;
                localStorage.setItem('quizlive_user', JSON.stringify(user));
                
                document.getElementById('welcomeUserName').textContent = user.name;
                showScreen('welcomeScreen');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Login Berhasil!',
                    text: `Selamat datang, ${user.name}! Kelas ${user.class}`,
                    confirmButtonColor: '#10b981',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('Login error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Login Gagal',
                    text: 'Terjadi kesalahan: ' + error.message,
                    confirmButtonColor: '#3b82f6'
                });
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtnText.classList.remove('hidden');
                loginBtnLoading.classList.add('hidden');
            }
        }

        // Logout user
        function logoutUser() {
            Swal.fire({
                title: 'Konfirmasi Keluar',
                text: 'Apakah Anda yakin ingin keluar dari akun?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    gameState.currentUser = null;
                    gameState.currentQuiz = null;
                    gameState.currentParticipant = null;
                    localStorage.removeItem('quizlive_user');
                    document.getElementById('gameCode').classList.add('hidden');
                    document.getElementById('joinCode').value = '';
                    showScreen('loginScreen');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil Keluar',
                        text: 'Anda telah keluar dari akun. Sampai jumpa!',
                        confirmButtonColor: '#10b981',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        // Setup real-time subscriptions
        function setupRealtimeSubscriptions() {
            // Subscribe to participants changes
            supabase
                .channel('participants')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'participants' }, (payload) => {
                    if (gameState.currentQuiz) {
                        loadParticipants();
                    }
                })
                .subscribe();

            // Subscribe to quiz status changes
            supabase
                .channel('quizzes')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'quizzes' }, (payload) => {
                    if (gameState.currentQuiz && payload.new.id === gameState.currentQuiz.id) {
                        if (payload.new.status === 'active' && gameState.currentScreen === 'lobbyScreen') {
                            startGameFromDatabase();
                        }
                    }
                })
                .subscribe();
        }

        // Join game function
        async function joinGame() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            if (!code) {
                alert('❌ Masukkan kode kuis!');
                return;
            }

            if (!gameState.currentUser) {
                alert('❌ Anda harus login terlebih dahulu!');
                showLoginScreen();
                return;
            }

            try {
                // Find quiz by code
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .select('*')
                    .eq('code', code)
                    .single();

                if (quizError || !quiz) {
                    alert('❌ Kode kuis tidak ditemukan!');
                    return;
                }

                // Check if student's class matches quiz class
                if (quiz.class && quiz.class !== gameState.currentUser.class) {
                    alert(`❌ Kuis ini khusus untuk kelas ${quiz.class}!\nAnda terdaftar di kelas ${gameState.currentUser.class}.`);
                    return;
                }

                // Check if user already registered for this quiz
                const { data: existingParticipant } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', quiz.id)
                    .eq('nis', gameState.currentUser.nis)
                    .single();

                if (existingParticipant) {
                    alert('❌ Anda sudah terdaftar untuk kuis ini!');
                    return;
                }

                // Add participant using logged in user data
                const { data: participant, error: participantError } = await supabase
                    .from('participants')
                    .insert([{
                        quiz_id: quiz.id,
                        name: gameState.currentUser.name,
                        nis: gameState.currentUser.nis,
                        class: gameState.currentUser.class,
                        score: 0
                    }])
                    .select()
                    .single();

                if (participantError) throw participantError;

                gameState.currentQuiz = quiz;
                gameState.currentParticipant = participant;
                
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                showScreen('lobbyScreen');
                
                if (quiz.status === 'active') {
                    startGameFromDatabase();
                }
                
            } catch (error) {
                console.error('Error joining game:', error);
                alert('❌ Gagal bergabung: ' + error.message);
            }
        }

        // Admin Panel Functions
        function toggleAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            if (!adminPanel.classList.contains('hidden')) {
                closeAdminPanel();
                return;
            }
            
            showAdminPasswordDialog();
        }

        function showAdminPasswordDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'adminPasswordDialog';
            dialog.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            dialog.innerHTML = `
                <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-md w-full border border-white/20">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">🔐</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Panel Admin Guru</h3>
                        <p class="text-white/70">Masukkan password untuk mengakses</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <input type="password" id="adminPassword" placeholder="Password admin..." 
                                   class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center"
                                   onkeypress="if(event.key==='Enter') checkAdminPassword()">
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="closeAdminPasswordDialog()" 
                                    class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                Batal
                            </button>
                            <button onclick="checkAdminPassword()" 
                                    class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                Masuk
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            setTimeout(() => {
                document.getElementById('adminPassword').focus();
            }, 100);
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'guruhebat2025') {
                closeAdminPasswordDialog();
                document.getElementById('adminPanel').classList.remove('hidden');
                showAdminSection('createQuiz');
                alert('✅ Selamat datang di Panel Admin!');
            } else {
                alert('❌ Password salah! Coba lagi.');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        function closeAdminPasswordDialog() {
            const dialog = document.getElementById('adminPasswordDialog');
            if (dialog) {
                dialog.remove();
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function showAdminSection(sectionName) {
            const sections = document.querySelectorAll('.admin-section');
            sections.forEach(section => section.classList.add('hidden'));
            
            const navButtons = document.querySelectorAll('.admin-nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-blue-100', 'text-blue-700');
            });
            
            const targetSection = document.getElementById('admin' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1));
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            const activeButton = event.target.closest('.admin-nav-btn');
            if (activeButton) {
                activeButton.classList.add('active', 'bg-blue-100', 'text-blue-700');
            }
        }

        // Utility functions
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function backToHome() {
            const currentUser = gameState.currentUser;
            
            gameState = {
                currentScreen: 'welcome',
                currentQuiz: null,
                currentParticipant: null,
                currentUser: currentUser,
                currentQuestionIndex: 0,
                score: 0,
                timeRemaining: 15,
                timer: null,
                questions: []
            };
            
            document.getElementById('gameCode').classList.add('hidden');
            document.getElementById('joinCode').value = '';
            
            if (currentUser) {
                showScreen('welcomeScreen');
            } else {
                showScreen('loginScreen');
            }
        }

    // TAMBAHKAN FUNCTION INI - Admin Sidebar Functions
    function toggleAdminSidebar() {
        const sidebar = document.getElementById('adminSidebar');
        const mainContent = document.getElementById('adminMainContent');
        const toggle = document.getElementById('adminSidebarToggle');
        
        if (sidebar.classList.contains('admin-sidebar-collapsed')) {
            // Expand sidebar
            sidebar.classList.remove('admin-sidebar-collapsed');
            sidebar.classList.remove('w-16');
            sidebar.classList.add('w-64');
            mainContent.classList.remove('admin-main-expanded');
            mainContent.classList.remove('ml-16');
            mainContent.classList.add('ml-64');
            toggle.classList.add('hidden');
        } else {
            // Collapse sidebar
            sidebar.classList.add('admin-sidebar-collapsed');
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-16');
            mainContent.classList.add('admin-main-expanded');
            mainContent.classList.remove('ml-64');
            mainContent.classList.add('ml-16');
            toggle.classList.remove('hidden');
        }
    }

    // TAMBAHKAN FUNCTION INI - Refresh Sidebar Stats
    async function refreshSidebarStats() {
        try {
            const { data: savedQuizzes } = await supabase.from('quizzes').select('id');
            const { data: participants } = await supabase.from('participants').select('id').eq('is_active', true);
            const { data: activeQuizzes } = await supabase.from('quizzes').select('id').eq('status', 'active');
            
            // Update stats in the appropriate section, not in sidebar
            document.getElementById('statsQuizCount').textContent = savedQuizzes?.length || 0;
            document.getElementById('statsParticipantCount').textContent = participants?.length || 0;
            document.getElementById('statsActiveQuiz').textContent = activeQuizzes?.length || 0;
        } catch (error) {
            console.error('Error refreshing sidebar stats:', error);
        }
    }

    // TAMBAHKAN FUNCTION INI - Refresh All Stats
    async function refreshAllStats() {
        try {
            const { data: allQuizzes } = await supabase.from('quizzes').select('id, status');
            const { data: allParticipants } = await supabase.from('participants').select('id');
            
            const totalQuizzes = allQuizzes?.length || 0;
            const totalParticipants = allParticipants?.length || 0;
            const activeQuizzes = allQuizzes?.filter(q => q.status === 'active').length || 0;
            const completedQuizzes = allQuizzes?.filter(q => q.status === 'completed').length || 0;
            
            // Update stats section
            document.getElementById('statsQuizCount').textContent = totalQuizzes;
            document.getElementById('statsParticipantCount').textContent = totalParticipants;
            document.getElementById('statsActiveQuiz').textContent = activeQuizzes;
            document.getElementById('statsCompletedQuiz').textContent = completedQuizzes;
            
        } catch (error) {
            console.error('Error refreshing all stats:', error);
        }
    }

    // TAMBAHKAN FUNCTION INI - Show Question Builder
    function showQuestionBuilder() {
        // Inisialisasi state question builder
        if (!window.questionBuilder) {
            window.questionBuilder = {
                questions: [],
                currentQuestionNumber: 1
            };
        }
        
        // Reset form
        document.getElementById('questionInput').value = '';
        document.getElementById('option0').value = '';
        document.getElementById('option1').value = '';
        document.getElementById('option2').value = '';
        document.getElementById('option3').value = '';
        document.querySelectorAll('input[name="correctAnswer"]').forEach(radio => radio.checked = false);
        
        // Update UI
        updateQuestionNumber();
        updateQuestionsList();
        
        // Show panel
        document.getElementById('questionBuilder').classList.remove('hidden');
    }

    // TAMBAHKAN FUNCTION INI - Close Question Builder
    function closeQuestionBuilder() {
        document.getElementById('questionBuilder').classList.add('hidden');
    }

    // TAMBAHKAN FUNCTION INI - Update Question Number
    function updateQuestionNumber() {
        document.getElementById('questionNumber').textContent = window.questionBuilder?.currentQuestionNumber || 1;
    }

    // TAMBAHKAN FUNCTION INI - Update Questions List
    function updateQuestionsList() {
        const questionsList = document.getElementById('questionsList');
        const questionCount = document.getElementById('questionCount');
        
        const questions = window.questionBuilder?.questions || [];
        questionCount.textContent = questions.length;
        
        if (questions.length === 0) {
            questionsList.innerHTML = `
                <div class="text-white/60 text-center py-8">
                    Belum ada soal. Mulai buat soal pertama!
                </div>
            `;
            return;
        }

        questionsList.innerHTML = questions.map((q, index) => `
            <div class="bg-white/20 rounded-lg p-3">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-white font-bold text-sm">Soal ${index + 1}</span>
                    <button onclick="removeQuestion(${index})" class="text-red-400 hover:text-red-300 text-sm">🗑️</button>
                </div>
                <p class="text-white/80 text-sm mb-2">${q.question_text}</p>
                <div class="text-xs text-white/60">
                    Jawaban: ${String.fromCharCode(65 + q.correct_answer)}. ${q.options[q.correct_answer]}
                </div>
            </div>
        `).join('');
    }

    // TAMBAHKAN FUNCTION INI - Add Question
    function addQuestion() {
        if (!window.questionBuilder) {
            window.questionBuilder = {
                questions: [],
                currentQuestionNumber: 1
            };
        }

        const questionText = document.getElementById('questionInput').value.trim();
        const options = [
            document.getElementById('option0').value.trim(),
            document.getElementById('option1').value.trim(),
            document.getElementById('option2').value.trim(),
            document.getElementById('option3').value.trim()
        ];
        
        const correctAnswer = document.querySelector('input[name="correctAnswer"]:checked');
        
        if (!questionText) {
            alert('❌ Masukkan pertanyaan!');
            return;
        }
        
        if (options.some(opt => !opt)) {
            alert('❌ Isi semua pilihan jawaban!');
            return;
        }
        
        if (!correctAnswer) {
            alert('❌ Pilih jawaban yang benar!');
            return;
        }

        const question = {
            question_text: questionText,
            options: options,
            correct_answer: parseInt(correctAnswer.value),
            order_number: window.questionBuilder.questions.length + 1
        };

        window.questionBuilder.questions.push(question);
        window.questionBuilder.currentQuestionNumber++;
        
        // Clear form
        document.getElementById('questionInput').value = '';
        document.getElementById('option0').value = '';
        document.getElementById('option1').value = '';
        document.getElementById('option2').value = '';
        document.getElementById('option3').value = '';
        document.querySelectorAll('input[name="correctAnswer"]').forEach(radio => radio.checked = false);
        
        updateQuestionNumber();
        updateQuestionsList();
        
        alert(`✅ Soal ${window.questionBuilder.questions.length} berhasil ditambahkan!`);
    }

    // TAMBAHKAN FUNCTION INI - Remove Question
    function removeQuestion(index) {
        if (confirm('Hapus soal ini?')) {
            window.questionBuilder.questions.splice(index, 1);
            // Update order numbers
            window.questionBuilder.questions.forEach((q, i) => {
                q.order_number = i + 1;
            });
            updateQuestionsList();
        }
    }

    // TAMBAHKAN FUNCTION INI - Show Excel Import
    function showExcelImport() {
        if (!window.excelImport) {
            window.excelImport = {
                file: null,
                questions: []
            };
        }
        
        window.excelImport.file = null;
        window.excelImport.questions = [];
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('processBtn').disabled = true;
        document.getElementById('createFromExcelBtn').disabled = true;
        updateExcelQuestionsList();
        document.getElementById('excelImport').classList.remove('hidden');
    }

    // TAMBAHKAN FUNCTION INI - Close Excel Import
    function closeExcelImport() {
        document.getElementById('excelImport').classList.add('hidden');
    }

    // TAMBAHKAN FUNCTION INI - Create Quiz with Samples
    async function createQuizWithSamples() {
        const title = document.getElementById('quizName').value || 'Kuis Baru';
        const teacherName = document.getElementById('teacherName').value || 'Guru';
        const subject = document.getElementById('quizSubject').value;
        const quizClass = document.getElementById('quizClass').value;
        const timeLimit = parseInt(document.getElementById('adminTimeLimit').value);
        
        if (!subject || !quizClass) {
            alert('❌ Pilih mata pelajaran dan kelas terlebih dahulu!');
            return;
        }
        
        try {
            // Generate unique code
            const code = generateGameCode();
            
            // Create quiz
            const { data: quiz, error: quizError } = await supabase
                .from('quizzes')
                .insert([{
                    title: title,
                    code: code,
                    creator_name: teacherName,
                    subject: subject,
                    class: quizClass,
                    question_count: 5,
                    time_limit: timeLimit,
                    status: 'waiting'
                }])
                .select()
                .single();

            if (quizError) throw quizError;

            // Insert sample questions
            const sampleQuestions = [
                {
                    question_text: "Apa ibu kota Indonesia?",
                    options: ["Jakarta", "Bandung", "Surabaya", "Medan"],
                    correct_answer: 0,
                    order_number: 1
                },
                {
                    question_text: "Siapa presiden pertama Indonesia?",
                    options: ["Soekarno", "Soeharto", "Habibie", "Megawati"],
                    correct_answer: 0,
                    order_number: 2
                },
                {
                    question_text: "Berapa jumlah pulau di Indonesia?",
                    options: ["13.000", "17.508", "20.000", "15.000"],
                    correct_answer: 1,
                    order_number: 3
                },
                {
                    question_text: "Apa mata uang Indonesia?",
                    options: ["Ringgit", "Rupiah", "Baht", "Peso"],
                    correct_answer: 1,
                    order_number: 4
                },
                {
                    question_text: "Gunung tertinggi di Indonesia adalah?",
                    options: ["Gunung Merapi", "Gunung Bromo", "Puncak Jaya", "Gunung Rinjani"],
                    correct_answer: 2,
                    order_number: 5
                }
            ];

            const questionsToInsert = sampleQuestions.map(q => ({
                ...q,
                quiz_id: quiz.id
            }));

            const { error: questionsError } = await supabase
                .from('questions')
                .insert(questionsToInsert);

            if (questionsError) throw questionsError;

            gameState.currentQuiz = quiz;
            document.getElementById('codeDisplay').textContent = code;
            document.getElementById('gameCode').classList.remove('hidden');
            
            closeAdminPanel();
            alert(`✅ Kuis "${title}" berhasil dibuat!\nKode: ${code}\nBagikan kode ini ke siswa.`);
            
            // Start quiz immediately
            await startQuiz();
            
        } catch (error) {
            console.error('Error creating quiz:', error);
            alert('❌ Gagal membuat kuis: ' + error.message);
        }
    }

    // TAMBAHKAN FUNCTION INI - Load Participants
    async function loadParticipants() {
        if (!gameState.currentQuiz) return;

        try {
            const { data: participants, error } = await supabase
                .from('participants')
                .select('*')
                .eq('quiz_id', gameState.currentQuiz.id)
                .eq('is_active', true)
                .order('joined_at');

            if (error) throw error;

            const participantsList = document.getElementById('participantsList');
            const participantCount = document.getElementById('participantCount');
            
            participantCount.textContent = participants.length;
            
            participantsList.innerHTML = participants.map(participant => `
                <div class="bg-white/20 rounded-lg p-3 flex items-center animate-slide-in">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
                        ${participant.name.charAt(0).toUpperCase()}
                    </div>
                    <span class="text-white font-medium">${participant.name}</span>
                    ${participant.id === gameState.currentParticipant?.id ? '<span class="ml-auto text-yellow-400">👤</span>' : ''}
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Error loading participants:', error);
        }
    }

    // TAMBAHKAN FUNCTION INI - Start Game from Database
    async function startGameFromDatabase() {
        try {
            // Load questions
            const { data: questions, error } = await supabase
                .from('questions')
                .select('*')
                .eq('quiz_id', gameState.currentQuiz.id)
                .order('order_number');

            if (error) throw error;

            gameState.questions = questions;
            gameState.currentQuestionIndex = 0;
            gameState.score = 0;
            
            showScreen('gameScreen');
            loadCurrentQuestion();
            
        } catch (error) {
            console.error('Error starting game:', error);
            alert('❌ Gagal memulai game: ' + error.message);
        }
    }

    // TAMBAHKAN FUNCTION INI - Load Current Question
    function loadCurrentQuestion() {
        const question = gameState.questions[gameState.currentQuestionIndex];
        if (!question) return;

        document.getElementById('currentQuestion').textContent = gameState.currentQuestionIndex + 1;
        document.getElementById('totalQuestions').textContent = gameState.questions.length;
        document.getElementById('questionText').textContent = question.question_text;
        document.getElementById('currentScore').textContent = gameState.score;

        // Create answer options
        const answerOptions = document.getElementById('answerOptions');
        answerOptions.innerHTML = question.options.map((option, index) => `
            <button onclick="selectAnswer(${index})" class="answer-btn bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-6 px-6 rounded-xl text-lg transition-all duration-300 transform hover:scale-105">
                ${String.fromCharCode(65 + index)}. ${option}
            </button>
        `).join('');

        // Start timer
        gameState.timeRemaining = gameState.currentQuiz.time_limit;
        startTimer();
    }

    // TAMBAHKAN FUNCTION INI - Start Timer
    function startTimer() {
        const timeLimit = gameState.currentQuiz.time_limit;
        gameState.timer = setInterval(() => {
            gameState.timeRemaining--;
            document.getElementById('timeRemaining').textContent = `⏰ ${gameState.timeRemaining}`;
            
            const percentage = (gameState.timeRemaining / timeLimit) * 100;
            document.getElementById('timerBar').style.width = percentage + '%';
            
            if (gameState.timeRemaining <= 0) {
                clearInterval(gameState.timer);
                selectAnswer(-1); // Time's up
            }
        }, 1000);
    }

    // TAMBAHKAN FUNCTION INI - Select Answer
    async function selectAnswer(selectedIndex) {
        clearInterval(gameState.timer);
        
        const question = gameState.questions[gameState.currentQuestionIndex];
        const isCorrect = selectedIndex === question.correct_answer;
        
        if (isCorrect) {
            gameState.score += 100;
        }

        // Save answer to database
        try {
            await supabase
                .from('quiz_answers')
                .insert([{
                    quiz_id: gameState.currentQuiz.id,
                    participant_id: gameState.currentParticipant.id,
                    question_number: gameState.currentQuestionIndex + 1,
                    selected_answer: selectedIndex,
                    is_correct: isCorrect
                }]);

            // Update participant score
            await supabase
                .from('participants')
                .update({ score: gameState.score })
                .eq('id', gameState.currentParticipant.id);

        } catch (error) {
            console.error('Error saving answer:', error);
        }

        // Show result
        const answerButtons = document.querySelectorAll('.answer-btn');
        answerButtons.forEach(btn => btn.disabled = true);
        answerButtons[question.correct_answer].classList.add('ring-4', 'ring-green-400');
        
        if (selectedIndex !== question.correct_answer && selectedIndex >= 0) {
            answerButtons[selectedIndex].classList.add('ring-4', 'ring-red-400');
        }

        setTimeout(() => {
            // Next question or results
            gameState.currentQuestionIndex++;
            if (gameState.currentQuestionIndex < gameState.questions.length) {
                loadCurrentQuestion();
            } else {
                showResults();
            }
        }, 2000);
    }

    // TAMBAHKAN FUNCTION INI - Show Results
    async function showResults() {
        try {
            // Get final leaderboard
            const { data: participants, error } = await supabase
                .from('participants')
                .select('*')
                .eq('quiz_id', gameState.currentQuiz.id)
                .order('score', { ascending: false });

            if (error) throw error;

            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = participants.map((participant, index) => {
                const medals = ['🥇', '🥈', '🥉'];
                const medal = medals[index] || '🏅';
                
                return `
                    <div class="bg-white/20 rounded-lg p-4 flex items-center justify-between animate-slide-in ${participant.id === gameState.currentParticipant?.id ? 'ring-2 ring-yellow-400' : ''}">
                        <div class="flex items-center">
                            <span class="text-2xl mr-4">${medal}</span>
                            <div>
                                <div class="text-white font-bold text-lg">${participant.name}</div>
                                <div class="text-white/60">Peringkat ${index + 1}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-yellow-400 font-bold text-xl">${participant.score}</div>
                            <div class="text-white/60">poin</div>
                        </div>
                    </div>
                `;
            }).join('');

            showScreen('resultsScreen');
            
        } catch (error) {
            console.error('Error loading results:', error);
            alert('❌ Gagal memuat hasil: ' + error.message);
        }
    }

        // Initialize admin panel on first load
        document.addEventListener('DOMContentLoaded', function() {
            const createQuizBtn = document.querySelector('[onclick="showAdminSection(\'createQuiz\')"]');
            if (createQuizBtn) {
                createQuizBtn.classList.add('active', 'bg-blue-100', 'text-blue-700');
            }
        });

    </script>
</body>
</html>
