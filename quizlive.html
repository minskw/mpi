<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizLive - Game Kuis Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { box-sizing: border-box; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        .timer-bar { transition: width 1s linear; }
        
        /* Admin Panel Styles */
        .admin-nav-btn.active {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .admin-nav-btn.active:hover {
            background-color: #dbeafe;
        }
        .admin-sidebar-collapsed {
            width: 70px !important;
        }
        .admin-sidebar-collapsed .sidebar-text {
            display: none !important;
        }
        .admin-sidebar-collapsed .sidebar-stats {
            display: none !important;
        }
        .admin-main-expanded {
            margin-left: 70px !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-teal-500 min-h-screen">
    <!-- Header -->
    <div class="bg-white/10 backdrop-blur-sm border-b border-white/20">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-white flex items-center cursor-pointer hover:text-yellow-300 transition-colors" onclick="toggleAdminPanel()">
                    <i class="fas fa-bullseye mr-2"></i> QuizLive
                </h1>
                <div id="gameCode" class="bg-white/20 px-4 py-2 rounded-lg text-white font-mono text-lg hidden">
                    Kode: <span id="codeDisplay">ABC123</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Login Screen -->
        <div id="loginScreen" class="text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-md mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-lock text-blue-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Masuk ke QuizLive</h2>
                <p class="text-xl text-white/80 mb-8">Login untuk mengikuti kuis</p>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">NIS (Nomor Induk)</label>
                        <input type="text" id="loginNIS" placeholder="Masukkan NIS Anda" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Password</label>
                        <input type="password" id="loginPassword" placeholder="Masukkan password" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    
                    <button onclick="loginUser()" id="loginBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                        <span id="loginBtnText"><i class="fas fa-rocket mr-2"></i>Masuk</span>
                        <span id="loginBtnLoading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Masuk...
                        </span>
                    </button>
                    
                    <div class="text-center">
                        <p class="text-white/70 mb-4">Belum punya akun?</p>
                        <button onclick="showRegisterScreen()" class="text-yellow-400 hover:text-yellow-300 font-bold underline transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Daftar Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="hidden text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-lg mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-user-plus text-green-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Daftar Akun Baru</h2>
                <p class="text-xl text-white/80 mb-8">Buat akun untuk mengikuti kuis</p>
                
                <div class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">NIS (Nomor Induk)</label>
                            <input type="text" id="registerNIS" placeholder="Contoh: 2024001" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                        </div>
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">Kelas</label>
                            <select id="registerClass" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50" style="background-color: rgba(255,255,255,0.2) !important; color: white !important;">
                                <option value="" style="background-color: #1f2937; color: white;">Pilih Kelas</option>
                                <option value="4A" style="background-color: #1f2937; color: white;">4A</option>
                                <option value="4B" style="background-color: #1f2937; color: white;">4B</option>
                                <option value="5A" style="background-color: #1f2937; color: white;">5A</option>
                                <option value="5B" style="background-color: #1f2937; color: white;">5B</option>
                                <option value="6A" style="background-color: #1f2937; color: white;">6A</option>
                                <option value="6B" style="background-color: #1f2937; color: white;">6B</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Nama Lengkap</label>
                        <input type="text" id="registerName" placeholder="Masukkan nama lengkap" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Password</label>
                        <input type="password" id="registerPassword" placeholder="Buat password (min. 6 karakter)" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    <div>
                        <label class="block text-white/80 text-lg font-medium mb-3">Konfirmasi Password</label>
                        <input type="password" id="confirmPassword" placeholder="Ulangi password" class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                    </div>
                    
                    <button onclick="registerUser()" id="registerBtn" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                        <span id="registerBtnText"><i class="fas fa-user-plus mr-2"></i>Daftar Akun</span>
                        <span id="registerBtnLoading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Mendaftar...
                        </span>
                    </button>
                    
                    <div class="text-center">
                        <p class="text-white/70 mb-4">Sudah punya akun?</p>
                        <button onclick="showLoginScreen()" class="text-yellow-400 hover:text-yellow-300 font-bold underline transition-colors">
                            <i class="fas fa-sign-in-alt mr-2"></i>Masuk Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Welcome Screen (After Login) -->
        <div id="welcomeScreen" class="hidden text-center">
            <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-2xl mx-auto border border-white/20">
                <div class="text-6xl mb-6 text-center"><i class="fas fa-graduation-cap text-yellow-400"></i></div>
                <h2 class="text-4xl font-bold text-white mb-4">Selamat Datang, <span id="welcomeUserName">Siswa</span>!</h2>
                <p class="text-xl text-white/80 mb-8">Siap mengikuti kuis hari ini?</p>
                
                <div class="bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-2xl p-8 border border-white/30 mb-8">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-white/80 text-lg font-medium mb-3">Kode Kuis</label>
                            <input type="text" id="joinCode" placeholder="Contoh: ABC123" class="w-full px-6 py-4 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center text-2xl font-mono tracking-widest uppercase">
                        </div>
                        <button onclick="joinGame()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-rocket mr-2"></i>Gabung Kuis
                        </button>
                        
                        <div class="pt-4 border-t border-white/20">
                            <button onclick="logoutUser()" class="text-white/70 hover:text-white transition-colors underline">
                                <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel - Clean Collapsible Sidebar -->
        <div id="adminPanel" class="hidden fixed inset-0 z-50">
            <!-- Sidebar -->
            <div id="adminSidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-xl transition-all duration-300 ease-in-out overflow-y-auto">
                <!-- Header -->
                <div class="bg-white border-b border-gray-200 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-chalkboard-teacher text-blue-500 text-xl mr-2"></i>
                            <div class="sidebar-text">
                                <h2 class="text-lg font-bold text-gray-800">Panel Admin</h2>
                                <p class="text-gray-600 text-xs">Kelola Kuis & Monitoring</p>
                            </div>
                        </div>
                        <button onclick="toggleAdminSidebar()" class="text-gray-500 hover:text-gray-700 transition-colors p-1 rounded">
                            <i class="fas fa-chevron-left text-sm"></i>
                        </button>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <div class="p-3">
                    <nav class="space-y-1">
                        <button onclick="showAdminSection('createQuiz')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-plus-circle text-green-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Buat Kuis Baru</span>
                        </button>
                        
                        <button onclick="showAdminSection('quizLibrary')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-book text-blue-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Library Kuis</span>
                        </button>
                        
                        <button onclick="showAdminSection('monitoring')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-chart-line text-orange-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Monitoring Live</span>
                        </button>
                        
                        <button onclick="showAdminSection('results')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-clipboard-list text-purple-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Kelola Hasil</span>
                        </button>
                        
                        <button onclick="showAdminSection('stats')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-chart-bar text-teal-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Statistik</span>
                        </button>
                    </nav>
                </div>

                <!-- Footer Buttons -->
                <div class="absolute bottom-0 left-0 right-0 p-3 border-t border-gray-200 bg-white">
                    <div class="space-y-2">
                        <button onclick="refreshSidebarStats()" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-sync-alt text-gray-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Refresh</span>
                        </button>
                        
                        <button onclick="closeAdminPanel()" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-times text-red-500 mr-3 w-5 text-center"></i>
                            <span class="font-medium text-gray-700 sidebar-text">Tutup Panel</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div id="adminMainContent" class="ml-64 min-h-screen bg-gray-50 transition-all duration-300">
                <!-- Create Quiz Section -->
                <div id="adminCreateQuiz" class="admin-section p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center mb-6">
                                <i class="fas fa-plus-circle text-green-500 text-xl mr-3"></i>
                                <h2 class="text-xl font-bold text-gray-800">Buat Kuis Baru</h2>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- Quiz Info Form -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Nama Kuis</label>
                                        <input type="text" id="quizName" placeholder="Contoh: Kuis Matematika Kelas 7" class="w-full px-3 py-2 bg-white text-gray-800 placeholder-gray-500 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Mata Pelajaran</label>
                                            <select id="quizSubject" class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="">Pilih Mapel</option>
                                                <option value="Matematika">Matematika</option>
                                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                                <option value="IPA">IPA</option>
                                                <option value="IPS">IPS</option>
                                                <option value="PKN">PKN</option>
                                                <option value="Agama">Agama</option>
                                                <option value="Seni Budaya">Seni Budaya</option>
                                                <option value="PJOK">PJOK</option>
                                                <option value="Prakarya">Prakarya</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Kelas</label>
                                            <select id="quizClass" class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="">Pilih Kelas</option>
                                                <option value="4A">4A</option>
                                                <option value="4B">4B</option>
                                                <option value="5A">5A</option>
                                                <option value="5B">5B</option>
                                                <option value="6A">6A</option>
                                                <option value="6B">6B</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Nama Guru</label>
                                            <input type="text" id="teacherName" placeholder="Nama Anda" class="w-full px-3 py-2 bg-white text-gray-800 placeholder-gray-500 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">Waktu per Soal</label>
                                            <select id="adminTimeLimit" class="w-full px-3 py-2 bg-white text-gray-800 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="10">10 detik</option>
                                                <option value="15" selected>15 detik</option>
                                                <option value="30">30 detik</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="space-y-3">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Pilih Metode Pembuatan</h3>
                                    
                                    <button onclick="showQuestionBuilder()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                                        <i class="fas fa-edit mr-2"></i>Buat Soal Sendiri
                                    </button>
                                    
                                    <button onclick="showExcelImport()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                                        <i class="fas fa-file-excel mr-2"></i>Import dari Excel
                                    </button>
                                    
                                    <button onclick="createQuizWithSamples()" class="w-full bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                                        <i class="fas fa-rocket mr-2"></i>Pakai Contoh Soal
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quiz Library Section -->
                <div id="adminQuizLibrary" class="admin-section hidden p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <i class="fas fa-book text-blue-500 text-xl mr-3"></i>
                                    <h2 class="text-xl font-bold text-gray-800">Library Kuis</h2>
                                </div>
                                <button onclick="showQuizLibrary()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-external-link-alt mr-2"></i>Buka Library Lengkap
                                </button>
                            </div>
                            
                            <div class="text-center py-12">
                                <i class="fas fa-book text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-600 mb-2">Library Kuis</h3>
                                <p class="text-gray-500 mb-6">Kelola semua kuis yang telah dibuat</p>
                                <button onclick="showQuizLibrary()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                                    Buka Library Kuis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Section -->
                <div id="adminMonitoring" class="admin-section hidden p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <i class="fas fa-chart-line text-orange-500 text-xl mr-3"></i>
                                    <h2 class="text-xl font-bold text-gray-800">Monitoring Live</h2>
                                </div>
                                <button onclick="showMonitoringPanel()" class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-external-link-alt mr-2"></i>Buka Monitoring Lengkap
                                </button>
                            </div>
                            
                            <div class="text-center py-12">
                                <i class="fas fa-chart-line text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-600 mb-2">Monitoring Real-time</h3>
                                <p class="text-gray-500 mb-6">Pantau peserta dan jalankan kuis secara live</p>
                                <button onclick="showMonitoringPanel()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                                    Buka Monitoring
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="adminResults" class="admin-section hidden p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <i class="fas fa-clipboard-list text-purple-500 text-xl mr-3"></i>
                                    <h2 class="text-xl font-bold text-gray-800">Kelola Hasil</h2>
                                </div>
                                <button onclick="showResultsManager()" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-external-link-alt mr-2"></i>Buka Kelola Hasil Lengkap
                                </button>
                            </div>
                            
                            <div class="text-center py-12">
                                <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-600 mb-2">Kelola Hasil Kuis</h3>
                                <p class="text-gray-500 mb-6">Lihat, filter, dan export hasil kuis</p>
                                <button onclick="showResultsManager()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                                    Kelola Hasil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Section -->
                <div id="adminStats" class="admin-section hidden p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center mb-6">
                                <i class="fas fa-chart-bar text-teal-500 text-xl mr-3"></i>
                                <h2 class="text-xl font-bold text-gray-800">Statistik Dashboard</h2>
                            </div>
                            
                            <div class="grid md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-blue-100">Total Kuis</p>
                                            <p class="text-2xl font-bold" id="statsQuizCount">0</p>
                                        </div>
                                        <i class="fas fa-book text-3xl text-blue-200"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-green-100">Total Peserta</p>
                                            <p class="text-2xl font-bold" id="statsParticipantCount">0</p>
                                        </div>
                                        <i class="fas fa-users text-3xl text-green-200"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg p-6 text-white">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-orange-100">Kuis Aktif</p>
                                            <p class="text-2xl font-bold" id="statsActiveQuiz">0</p>
                                        </div>
                                        <i class="fas fa-play-circle text-3xl text-orange-200"></i>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-purple-100">Kuis Selesai</p>
                                            <p class="text-2xl font-bold" id="statsCompletedQuiz">0</p>
                                        </div>
                                        <i class="fas fa-check-circle text-3xl text-purple-200"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button onclick="refreshAllStats()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh Semua Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsed Sidebar Toggle -->
            <div id="adminSidebarToggle" class="hidden fixed left-0 top-1/2 transform -translate-y-1/2 z-60">
                <button onclick="toggleAdminSidebar()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-r-lg shadow-lg transition-colors">
                    <i class="fas fa-chevron-right text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Other panels and screens (Excel Import, Monitoring Panel, Results Manager, Quiz Library, Question Builder, Lobby, Game, Results) -->
        <!-- ... -->

    </div>

    <script>
        // Kredensial Supabase - Terhubung ke database
        const SUPABASE_URL = 'https://lglhmbdsldqlcjnkampd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnbGhtYmRzbGRxbGNqbmthbXBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDc4NTgsImV4cCI6MjA3NTEyMzg1OH0.857DRQpbvcfSaVtNDkgBKvx2PYvEfmA8-mlPiiZ6Ib0';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Game State
        let gameState = {
            currentScreen: 'login',
            currentQuiz: null,
            currentParticipant: null,
            currentUser: null,
            currentQuestionIndex: 0,
            score: 0,
            timeRemaining: 15,
            timer: null,
            questions: []
        };

        // Question Builder State
        let questionBuilder = {
            questions: [],
            currentQuestionNumber: 1
        };

        // Excel Import State
        let excelImport = {
            file: null,
            questions: []
        };

        // Quiz Library State
        let quizLibrary = {
            allQuizzes: [],
            filteredQuizzes: []
        };

        // Results Manager State
        let resultsManager = {
            allResults: [],
            filteredResults: []
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            setupRealtimeSubscriptions();
            checkUserSession();
        });

        // Check if user is already logged in
        function checkUserSession() {
            const savedUser = localStorage.getItem('quizlive_user');
            if (savedUser) {
                gameState.currentUser = JSON.parse(savedUser);
                document.getElementById('welcomeUserName').textContent = gameState.currentUser.name;
                showScreen('welcomeScreen');
            } else {
                showScreen('loginScreen');
            }
        }

        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginNIS').value = '';
            document.getElementById('loginPassword').value = '';
            showScreen('loginScreen');
        }

        // Show register screen
        function showRegisterScreen() {
            document.getElementById('registerNIS').value = '';
            document.getElementById('registerName').value = '';
            document.getElementById('registerClass').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            showScreen('registerScreen');
        }

        // Register new user
        async function registerUser() {
            const nis = document.getElementById('registerNIS').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const studentClass = document.getElementById('registerClass').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validation
            if (!nis || !name || !studentClass || !password || !confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Data Tidak Lengkap',
                    text: 'Mohon lengkapi semua data yang diperlukan!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            if (password.length < 6) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Terlalu Pendek',
                    text: 'Password minimal harus 6 karakter!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            if (password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Tidak Cocok',
                    text: 'Konfirmasi password tidak sesuai dengan password yang dimasukkan!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading state
            const registerBtn = document.getElementById('registerBtn');
            const registerBtnText = document.getElementById('registerBtnText');
            const registerBtnLoading = document.getElementById('registerBtnLoading');
            
            registerBtn.disabled = true;
            registerBtnText.classList.add('hidden');
            registerBtnLoading.classList.remove('hidden');

            try {
                // Show processing notification
                Swal.fire({
                    title: 'Memproses Pendaftaran...',
                    text: 'Mohon tunggu sebentar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Check if NIS already exists
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('*')
                    .eq('nis', nis)
                    .single();

                if (existingUser) {
                    Swal.fire({
                        icon: 'error',
                        title: 'NIS Sudah Terdaftar',
                        text: 'NIS ini sudah digunakan. Gunakan NIS lain atau silakan login.',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }

                // Create new user
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([{
                        nis: nis,
                        name: name,
                        class: studentClass,
                        password: password
                    }])
                    .select()
                    .single();

                if (error) throw error;

                Swal.fire({
                    icon: 'success',
                    title: 'Pendaftaran Berhasil!',
                    text: `Akun untuk ${name} berhasil dibuat. Silakan login dengan NIS dan password Anda.`,
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    showLoginScreen();
                });

            } catch (error) {
                console.error('Registration error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Pendaftaran Gagal',
                    text: 'Terjadi kesalahan: ' + error.message,
                    confirmButtonColor: '#3b82f6'
                });
            } finally {
                // Reset button state
                registerBtn.disabled = false;
                registerBtnText.classList.remove('hidden');
                registerBtnLoading.classList.add('hidden');
            }
        }

        // Login user
        async function loginUser() {
            const nis = document.getElementById('loginNIS').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!nis || !password) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Belum Lengkap',
                    text: 'Mohon masukkan NIS dan password Anda!',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading state
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginBtnLoading = document.getElementById('loginBtnLoading');
            
            loginBtn.disabled = true;
            loginBtnText.classList.add('hidden');
            loginBtnLoading.classList.remove('hidden');

            try {
                // Show processing notification
                Swal.fire({
                    title: 'Memproses Login...',
                    text: 'Mohon tunggu sebentar',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('nis', nis)
                    .eq('password', password)
                    .single();

                if (error || !user) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Login Gagal',
                        text: 'NIS atau password yang Anda masukkan salah!',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }

                // Save user session
                gameState.currentUser = user;
                localStorage.setItem('quizlive_user', JSON.stringify(user));
                
                document.getElementById('welcomeUserName').textContent = user.name;
                showScreen('welcomeScreen');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Login Berhasil!',
                    text: `Selamat datang, ${user.name}! Kelas ${user.class}`,
                    confirmButtonColor: '#10b981',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('Login error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Login Gagal',
                    text: 'Terjadi kesalahan: ' + error.message,
                    confirmButtonColor: '#3b82f6'
                });
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtnText.classList.remove('hidden');
                loginBtnLoading.classList.add('hidden');
            }
        }

        // Logout user
        function logoutUser() {
            Swal.fire({
                title: 'Konfirmasi Keluar',
                text: 'Apakah Anda yakin ingin keluar dari akun?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    gameState.currentUser = null;
                    gameState.currentQuiz = null;
                    gameState.currentParticipant = null;
                    localStorage.removeItem('quizlive_user');
                    document.getElementById('gameCode').classList.add('hidden');
                    document.getElementById('joinCode').value = '';
                    showScreen('loginScreen');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil Keluar',
                        text: 'Anda telah keluar dari akun. Sampai jumpa!',
                        confirmButtonColor: '#10b981',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        // Setup real-time subscriptions
        function setupRealtimeSubscriptions() {
            // Subscribe to participants changes
            supabase
                .channel('participants')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'participants' }, (payload) => {
                    if (gameState.currentQuiz) {
                        loadParticipants();
                    }
                })
                .subscribe();

            // Subscribe to quiz status changes
            supabase
                .channel('quizzes')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'quizzes' }, (payload) => {
                    if (gameState.currentQuiz && payload.new.id === gameState.currentQuiz.id) {
                        if (payload.new.status === 'active' && gameState.currentScreen === 'lobbyScreen') {
                            startGameFromDatabase();
                        }
                    }
                })
                .subscribe();
        }

        // Show Excel import
        function showExcelImport() {
            excelImport.file = null;
            excelImport.questions = [];
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('processBtn').disabled = true;
            document.getElementById('createFromExcelBtn').disabled = true;
            updateExcelQuestionsList();
            document.getElementById('excelImport').classList.remove('hidden');
        }

        // Close Excel import
        function closeExcelImport() {
            document.getElementById('excelImport').classList.add('hidden');
        }

        // Handle Excel file selection
        function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            excelImport.file = file;
            
            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('processBtn').disabled = false;
        }

        // Process Excel file
        function processExcelFile() {
            if (!excelImport.file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Parse questions
                    const questions = parseExcelQuestions(jsonData);
                    
                    if (questions.length === 0) {
                        alert('❌ Tidak ada soal valid ditemukan!\nPastikan format Excel sesuai template.');
                        return;
                    }
                    
                    excelImport.questions = questions;
                    updateExcelQuestionsList();
                    document.getElementById('createFromExcelBtn').disabled = false;
                    
                    alert(`✅ Berhasil memproses ${questions.length} soal dari Excel!`);
                    
                } catch (error) {
                    console.error('Error processing Excel:', error);
                    alert('❌ Gagal memproses file Excel!\nPastikan format file benar.');
                }
            };
            
            reader.readAsArrayBuffer(excelImport.file);
        }

        // Parse Excel questions
        function parseExcelQuestions(data) {
            const questions = [];
            
            // Skip header row, start from row 1
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                
                // Skip empty rows
                if (!row || row.length < 6) continue;
                
                const questionText = row[0]?.toString().trim();
                const optionA = row[1]?.toString().trim();
                const optionB = row[2]?.toString().trim();
                const optionC = row[3]?.toString().trim();
                const optionD = row[4]?.toString().trim();
                const correctAnswer = row[5]?.toString().trim().toUpperCase();
                
                // Validate required fields
                if (!questionText || !optionA || !optionB || !optionC || !optionD || !correctAnswer) {
                    continue;
                }
                
                // Convert correct answer to index
                let correctIndex = -1;
                switch (correctAnswer) {
                    case 'A': correctIndex = 0; break;
                    case 'B': correctIndex = 1; break;
                    case 'C': correctIndex = 2; break;
                    case 'D': correctIndex = 3; break;
                    default: continue; // Skip invalid answers
                }
                
                questions.push({
                    question_text: questionText,
                    options: [optionA, optionB, optionC, optionD],
                    correct_answer: correctIndex,
                    order_number: questions.length + 1
                });
            }
            
            return questions;
        }

        // Update Excel questions list
        function updateExcelQuestionsList() {
            const questionsList = document.getElementById('excelQuestionsList');
            const questionCount = document.getElementById('excelQuestionCount');
            
            questionCount.textContent = excelImport.questions.length;
            
            if (excelImport.questions.length === 0) {
                questionsList.innerHTML = `
                    <div class="text-white/60 text-center py-8">
                        Upload file Excel untuk melihat preview soal
                    </div>
                `;
                return;
            }

            questionsList.innerHTML = excelImport.questions.map((q, index) => `
                <div class="bg-white/20 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-white font-bold text-sm">Soal ${index + 1}</span>
                        <span class="text-green-400 text-xs">Excel</span>
                    </div>
                    <p class="text-white/80 text-sm mb-2">${q.question_text}</p>
                    <div class="text-xs text-white/60">
                        Jawaban: ${String.fromCharCode(65 + q.correct_answer)}. ${q.options[q.correct_answer]}
                    </div>
                </div>
            `).join('');
        }

        // Create quiz from Excel
        async function createQuizFromExcel() {
            if (excelImport.questions.length === 0) {
                alert('❌ Tidak ada soal untuk dibuat kuis!');
                return;
            }

            const title = document.getElementById('quizName').value || 'Kuis dari Excel';
            const teacherName = document.getElementById('teacherName').value || 'Guru';
            const timeLimit = parseInt(document.getElementById('adminTimeLimit').value);
            
            try {
                const code = generateGameCode();
                
                // Create quiz
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .insert([{
                        title: title,
                        code: code,
                        creator_name: teacherName,
                        question_count: excelImport.questions.length,
                        time_limit: timeLimit,
                        status: 'waiting'
                    }])
                    .select()
                    .single();

                if (quizError) throw quizError;

                // Insert Excel questions
                const questionsToInsert = excelImport.questions.map(q => ({
                    ...q,
                    quiz_id: quiz.id
                }));

                const { error: questionsError } = await supabase
                    .from('questions')
                    .insert(questionsToInsert);

                if (questionsError) throw questionsError;

                gameState.currentQuiz = quiz;
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                closeExcelImport();
                closeAdminPanel();
                alert(`✅ Kuis "${title}" berhasil dibuat dari Excel!\nKode: ${code}\nTotal: ${excelImport.questions.length} soal\nBagikan kode ini ke siswa.`);
                
                await startQuiz();
                
            } catch (error) {
                console.error('Error creating quiz from Excel:', error);
                alert('❌ Gagal membuat kuis dari Excel: ' + error.message);
            }
        }

        // Download Excel template
        function downloadTemplate() {
            // Create template data
            const templateData = [
                ['Pertanyaan', 'Pilihan A', 'Pilihan B', 'Pilihan C', 'Pilihan D', 'Jawaban Benar'],
                ['Apa ibu kota Indonesia?', 'Jakarta', 'Bandung', 'Surabaya', 'Medan', 'A'],
                ['Siapa presiden pertama Indonesia?', 'Soekarno', 'Soeharto', 'Habibie', 'Megawati', 'A'],
                ['Berapa jumlah pulau di Indonesia?', '13.000', '17.508', '20.000', '15.000', 'B']
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Set column widths
            ws['!cols'] = [
                { width: 40 }, // Pertanyaan
                { width: 20 }, // Pilihan A
                { width: 20 }, // Pilihan B
                { width: 20 }, // Pilihan C
                { width: 20 }, // Pilihan D
                { width: 15 }  // Jawaban Benar
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Template Soal');
            
            // Download file
            XLSX.writeFile(wb, 'Template_Soal_QuizLive.xlsx');
            
            alert('✅ Template Excel berhasil didownload!\nIsi template dengan soal Anda, lalu upload kembali.');
        }

        // Show question builder
        function showQuestionBuilder() {
            questionBuilder.questions = [];
            questionBuilder.currentQuestionNumber = 1;
            updateQuestionNumber();
            clearQuestionForm();
            updateQuestionsList();
            document.getElementById('questionBuilder').classList.remove('hidden');
        }

        // Close question builder
        function closeQuestionBuilder() {
            document.getElementById('questionBuilder').classList.add('hidden');
        }

        // Add question to builder
        function addQuestion() {
            const questionText = document.getElementById('questionInput').value.trim();
            const options = [
                document.getElementById('option0').value.trim(),
                document.getElementById('option1').value.trim(),
                document.getElementById('option2').value.trim(),
                document.getElementById('option3').value.trim()
            ];
            
            const correctAnswer = document.querySelector('input[name="correctAnswer"]:checked');
            
            if (!questionText) {
                alert('❌ Masukkan pertanyaan!');
                return;
            }
            
            if (options.some(opt => !opt)) {
                alert('❌ Isi semua pilihan jawaban!');
                return;
            }
            
            if (!correctAnswer) {
                alert('❌ Pilih jawaban yang benar!');
                return;
            }

            const question = {
                question_text: questionText,
                options: options,
                correct_answer: parseInt(correctAnswer.value),
                order_number: questionBuilder.questions.length + 1
            };

            questionBuilder.questions.push(question);
            questionBuilder.currentQuestionNumber++;
            
            clearQuestionForm();
            updateQuestionNumber();
            updateQuestionsList();
            
            alert(`✅ Soal ${questionBuilder.questions.length} berhasil ditambahkan!`);
        }

        // Clear question form
        function clearQuestionForm() {
            document.getElementById('questionInput').value = '';
            document.getElementById('option0').value = '';
            document.getElementById('option1').value = '';
            document.getElementById('option2').value = '';
            document.getElementById('option3').value = '';
            document.querySelectorAll('input[name="correctAnswer"]').forEach(radio => radio.checked = false);
        }

        // Update question number display
        function updateQuestionNumber() {
            document.getElementById('questionNumber').textContent = questionBuilder.currentQuestionNumber;
        }

        // Update questions list
        function updateQuestionsList() {
            const questionsList = document.getElementById('questionsList');
            const questionCount = document.getElementById('questionCount');
            
            questionCount.textContent = questionBuilder.questions.length;
            
            if (questionBuilder.questions.length === 0) {
                questionsList.innerHTML = `
                    <div class="text-white/60 text-center py-8">
                        Belum ada soal. Mulai buat soal pertama!
                    </div>
                `;
                return;
            }

            questionsList.innerHTML = questionBuilder.questions.map((q, index) => `
                <div class="bg-white/20 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-white font-bold text-sm">Soal ${index + 1}</span>
                        <button onclick="removeQuestion(${index})" class="text-red-400 hover:text-red-300 text-sm">🗑️</button>
                    </div>
                    <p class="text-white/80 text-sm mb-2">${q.question_text}</p>
                    <div class="text-xs text-white/60">
                        Jawaban: ${String.fromCharCode(65 + q.correct_answer)}. ${q.options[q.correct_answer]}
                    </div>
                </div>
            `).join('');
        }

        // Remove question
        function removeQuestion(index) {
            if (confirm('Hapus soal ini?')) {
                questionBuilder.questions.splice(index, 1);
                // Update order numbers
                questionBuilder.questions.forEach((q, i) => {
                    q.order_number = i + 1;
                });
                updateQuestionsList();
            }
        }

        // Clear all questions
        function clearAllQuestions() {
            if (confirm('Hapus semua soal?')) {
                questionBuilder.questions = [];
                questionBuilder.currentQuestionNumber = 1;
                updateQuestionNumber();
                updateQuestionsList();
            }
        }

        // Finish questions and create quiz
        async function finishQuestions() {
            if (questionBuilder.questions.length === 0) {
                alert('❌ Buat minimal 1 soal!');
                return;
            }

            const title = document.getElementById('quizName').value || 'Kuis Baru';
            const teacherName = document.getElementById('teacherName').value || 'Guru';
            const timeLimit = parseInt(document.getElementById('adminTimeLimit').value);
            
            try {
                const code = generateGameCode();
                
                // Create quiz
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .insert([{
                        title: title,
                        code: code,
                        creator_name: teacherName,
                        question_count: questionBuilder.questions.length,
                        time_limit: timeLimit,
                        status: 'waiting'
                    }])
                    .select()
                    .single();

                if (quizError) throw quizError;

                // Insert custom questions
                const questionsToInsert = questionBuilder.questions.map(q => ({
                    ...q,
                    quiz_id: quiz.id
                }));

                const { error: questionsError } = await supabase
                    .from('questions')
                    .insert(questionsToInsert);

                if (questionsError) throw questionsError;

                gameState.currentQuiz = quiz;
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                closeQuestionBuilder();
                closeAdminPanel();
                alert(`✅ Kuis "${title}" berhasil dibuat!\nKode: ${code}\nTotal: ${questionBuilder.questions.length} soal\nBagikan kode ini ke siswa.`);
                
                await startQuiz();
                
            } catch (error) {
                console.error('Error creating quiz:', error);
                alert('❌ Gagal membuat kuis: ' + error.message);
            }
        }

        // Create quiz with sample questions
        async function createQuizWithSamples() {
            const title = document.getElementById('quizName').value || 'Kuis Baru';
            const teacherName = document.getElementById('teacherName').value || 'Guru';
            const subject = document.getElementById('quizSubject').value;
            const quizClass = document.getElementById('quizClass').value;
            const timeLimit = parseInt(document.getElementById('adminTimeLimit').value);
            
            if (!subject || !quizClass) {
                alert('❌ Pilih mata pelajaran dan kelas terlebih dahulu!');
                return;
            }
            
            try {
                // Generate unique code
                const code = generateGameCode();
                
                // Create quiz
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .insert([{
                        title: title,
                        code: code,
                        creator_name: teacherName,
                        subject: subject,
                        class: quizClass,
                        question_count: 5,
                        time_limit: timeLimit,
                        status: 'waiting'
                    }])
                    .select()
                    .single();

                if (quizError) throw quizError;

                // Insert sample questions
                const sampleQuestions = [
                    {
                        question_text: "Apa ibu kota Indonesia?",
                        options: ["Jakarta", "Bandung", "Surabaya", "Medan"],
                        correct_answer: 0,
                        order_number: 1
                    },
                    {
                        question_text: "Siapa presiden pertama Indonesia?",
                        options: ["Soekarno", "Soeharto", "Habibie", "Megawati"],
                        correct_answer: 0,
                        order_number: 2
                    },
                    {
                        question_text: "Berapa jumlah pulau di Indonesia?",
                        options: ["13.000", "17.508", "20.000", "15.000"],
                        correct_answer: 1,
                        order_number: 3
                    },
                    {
                        question_text: "Apa mata uang Indonesia?",
                        options: ["Ringgit", "Rupiah", "Baht", "Peso"],
                        correct_answer: 1,
                        order_number: 4
                    },
                    {
                        question_text: "Gunung tertinggi di Indonesia adalah?",
                        options: ["Gunung Merapi", "Gunung Bromo", "Puncak Jaya", "Gunung Rinjani"],
                        correct_answer: 2,
                        order_number: 5
                    }
                ];

                const questionsToInsert = sampleQuestions.map(q => ({
                    ...q,
                    quiz_id: quiz.id
                }));

                const { error: questionsError } = await supabase
                    .from('questions')
                    .insert(questionsToInsert);

                if (questionsError) throw questionsError;

                gameState.currentQuiz = quiz;
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                closeAdminPanel();
                alert(`✅ Kuis "${title}" berhasil dibuat!\nKode: ${code}\nBagikan kode ini ke siswa.`);
                
                // Start quiz immediately
                await startQuiz();
                
            } catch (error) {
                console.error('Error creating quiz:', error);
                alert('❌ Gagal membuat kuis: ' + error.message);
            }
        }

        // Join game
        async function joinGame() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            if (!code) {
                alert('❌ Masukkan kode kuis!');
                return;
            }

            if (!gameState.currentUser) {
                alert('❌ Anda harus login terlebih dahulu!');
                showLoginScreen();
                return;
            }

            try {
                // Find quiz by code
                const { data: quiz, error: quizError } = await supabase
                    .from('quizzes')
                    .select('*')
                    .eq('code', code)
                    .single();

                if (quizError || !quiz) {
                    alert('❌ Kode kuis tidak ditemukan!');
                    return;
                }

                // Check if student's class matches quiz class
                if (quiz.class && quiz.class !== gameState.currentUser.class) {
                    alert(`❌ Kuis ini khusus untuk kelas ${quiz.class}!\nAnda terdaftar di kelas ${gameState.currentUser.class}.`);
                    return;
                }

                // Check if user already registered for this quiz
                const { data: existingParticipant } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', quiz.id)
                    .eq('nis', gameState.currentUser.nis)
                    .single();

                if (existingParticipant) {
                    alert('❌ Anda sudah terdaftar untuk kuis ini!');
                    return;
                }

                // Add participant using logged in user data
                const { data: participant, error: participantError } = await supabase
                    .from('participants')
                    .insert([{
                        quiz_id: quiz.id,
                        name: gameState.currentUser.name,
                        nis: gameState.currentUser.nis,
                        class: gameState.currentUser.class,
                        score: 0
                    }])
                    .select()
                    .single();

                if (participantError) throw participantError;

                gameState.currentQuiz = quiz;
                gameState.currentParticipant = participant;
                
                document.getElementById('codeDisplay').textContent = code;
                document.getElementById('gameCode').classList.remove('hidden');
                
                showScreen('lobbyScreen');
                await loadParticipants();
                
                if (quiz.status === 'active') {
                    startGameFromDatabase();
                }
                
            } catch (error) {
                console.error('Error joining game:', error);
                alert('❌ Gagal bergabung: ' + error.message);
            }
        }

        // Load participants
        async function loadParticipants() {
            if (!gameState.currentQuiz) return;

            try {
                const { data: participants, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', gameState.currentQuiz.id)
                    .eq('is_active', true)
                    .order('joined_at');

                if (error) throw error;

                const participantsList = document.getElementById('participantsList');
                const participantCount = document.getElementById('participantCount');
                
                participantCount.textContent = participants.length;
                
                participantsList.innerHTML = participants.map(participant => `
                    <div class="bg-white/20 rounded-lg p-3 flex items-center animate-slide-in">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
                            ${participant.name.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-medium">${participant.name}</span>
                        ${participant.id === gameState.currentParticipant?.id ? '<span class="ml-auto text-yellow-400">👤</span>' : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }

        // Start quiz
        async function startQuiz() {
            try {
                const { error } = await supabase
                    .from('quizzes')
                    .update({ status: 'active' })
                    .eq('id', gameState.currentQuiz.id);

                if (error) throw error;
                
                alert('🚀 Kuis dimulai! Semua peserta akan otomatis masuk ke game.');
                
            } catch (error) {
                console.error('Error starting quiz:', error);
                alert('❌ Gagal memulai kuis: ' + error.message);
            }
        }

        // Start game from database
        async function startGameFromDatabase() {
            try {
                // Load questions
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('*')
                    .eq('quiz_id', gameState.currentQuiz.id)
                    .order('order_number');

                if (error) throw error;

                // Shuffle questions for each participant
                gameState.questions = shuffleArray([...questions]);
                
                // Shuffle answer options for each question while preserving correct answer
                gameState.questions = gameState.questions.map(question => {
                    const shuffledQuestion = { ...question };
                    const originalOptions = [...question.options];
                    const correctOption = originalOptions[question.correct_answer];
                    
                    // Create array of indices and shuffle them
                    const indices = [0, 1, 2, 3];
                    const shuffledIndices = shuffleArray(indices);
                    
                    // Rearrange options based on shuffled indices
                    shuffledQuestion.options = shuffledIndices.map(index => originalOptions[index]);
                    
                    // Find new position of correct answer
                    shuffledQuestion.correct_answer = shuffledIndices.indexOf(question.correct_answer);
                    
                    return shuffledQuestion;
                });
                
                gameState.currentQuestionIndex = 0;
                gameState.score = 0;
                
                showScreen('gameScreen');
                loadCurrentQuestion();
                
            } catch (error) {
                console.error('Error starting game:', error);
                alert('❌ Gagal memulai game: ' + error.message);
            }
        }

        // Load current question
        function loadCurrentQuestion() {
            const question = gameState.questions[gameState.currentQuestionIndex];
            if (!question) return;

            document.getElementById('currentQuestion').textContent = gameState.currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = gameState.questions.length;
            document.getElementById('questionText').textContent = question.question_text;
            document.getElementById('currentScore').textContent = gameState.score;

            // Create answer options
            const answerOptions = document.getElementById('answerOptions');
            answerOptions.innerHTML = question.options.map((option, index) => `
                <button onclick="selectAnswer(${index})" class="answer-btn bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-6 px-6 rounded-xl text-lg transition-all duration-300 transform hover:scale-105">
                    ${String.fromCharCode(65 + index)}. ${option}
                </button>
            `).join('');

            // Start timer
            gameState.timeRemaining = gameState.currentQuiz.time_limit;
            startTimer();
        }

        // Select answer
        async function selectAnswer(selectedIndex) {
            clearInterval(gameState.timer);
            
            const question = gameState.questions[gameState.currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct_answer;
            
            if (isCorrect) {
                gameState.score += 100;
            }

            // Save answer to database
            try {
                await supabase
                    .from('quiz_answers')
                    .insert([{
                        quiz_id: gameState.currentQuiz.id,
                        participant_id: gameState.currentParticipant.id,
                        question_number: gameState.currentQuestionIndex + 1,
                        selected_answer: selectedIndex,
                        is_correct: isCorrect
                    }]);

                // Update participant score
                await supabase
                    .from('participants')
                    .update({ score: gameState.score })
                    .eq('id', gameState.currentParticipant.id);

            } catch (error) {
                console.error('Error saving answer:', error);
            }

            // Show result
            const answerButtons = document.querySelectorAll('.answer-btn');
            answerButtons.forEach(btn => btn.disabled = true);
            answerButtons[question.correct_answer].classList.add('ring-4', 'ring-green-400');
            
            if (selectedIndex !== question.correct_answer && selectedIndex >= 0) {
                answerButtons[selectedIndex].classList.add('ring-4', 'ring-red-400');
            }

            setTimeout(() => {
                // Next question or results
                gameState.currentQuestionIndex++;
                if (gameState.currentQuestionIndex < gameState.questions.length) {
                    loadCurrentQuestion();
                } else {
                    showResults();
                }
            }, 2000);
        }

        // Start timer
        function startTimer() {
            const timeLimit = gameState.currentQuiz.time_limit;
            gameState.timer = setInterval(() => {
                gameState.timeRemaining--;
                document.getElementById('timeRemaining').textContent = `⏰ ${gameState.timeRemaining}`;
                
                const percentage = (gameState.timeRemaining / timeLimit) * 100;
                document.getElementById('timerBar').style.width = percentage + '%';
                
                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timer);
                    selectAnswer(-1); // Time's up
                }
            }, 1000);
        }

        // Show results
        async function showResults() {
            try {
                // Get final leaderboard
                const { data: participants, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('quiz_id', gameState.currentQuiz.id)
                    .order('score', { ascending: false });

                if (error) throw error;

                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = participants.map((participant, index) => {
                    const medals = ['🥇', '🥈', '🥉'];
                    const medal = medals[index] || '🏅';
                    
                    return `
                        <div class="bg-white/20 rounded-lg p-4 flex items-center justify-between animate-slide-in ${participant.id === gameState.currentParticipant?.id ? 'ring-2 ring-yellow-400' : ''}">
                            <div class="flex items-center">
                                <span class="text-2xl mr-4">${medal}</span>
                                <div>
                                    <div class="text-white font-bold text-lg">${participant.name}</div>
                                    <div class="text-white/60">Peringkat ${index + 1}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-400 font-bold text-xl">${participant.score}</div>
                                <div class="text-white/60">poin</div>
                            </div>
                        </div>
                    `;
                }).join('');

                showScreen('resultsScreen');
                
            } catch (error) {
                console.error('Error loading results:', error);
                alert('❌ Gagal memuat hasil: ' + error.message);
            }
        }

        // Utility functions
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Shuffle array using Fisher-Yates algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showScreen(screenName) {
            const screens = ['loginScreen', 'registerScreen', 'welcomeScreen', 'lobbyScreen', 'gameScreen', 'resultsScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenName).classList.remove('hidden');
            gameState.currentScreen = screenName;
        }

        // Admin Panel Functions
        function toggleAdminPanel() {
            console.log('Admin panel clicked');
            
            const adminPanel = document.getElementById('adminPanel');
            if (!adminPanel.classList.contains('hidden')) {
                closeAdminPanel();
                return;
            }
            
            showAdminPasswordDialog();
        }

        function showAdminPasswordDialog() {
            // Create password dialog
            const dialog = document.createElement('div');
            dialog.id = 'adminPasswordDialog';
            dialog.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            dialog.innerHTML = `
                <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 max-w-md w-full border border-white/20">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">🔐</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Panel Admin Guru</h3>
                        <p class="text-white/70">Masukkan password untuk mengakses</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <input type="password" id="adminPassword" placeholder="Password admin..." 
                                   class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 text-center"
                                   onkeypress="if(event.key==='Enter') checkAdminPassword()">
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="closeAdminPasswordDialog()" 
                                    class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                Batal
                            </button>
                            <button onclick="checkAdminPassword()" 
                                    class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                Masuk
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <p class="text-white/60 text-sm">2025 &copy; MAHFUD SIDIK<br><i>Guru Kreatif, Siswa Aktif</i></p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // Focus on password input
            setTimeout(() => {
                document.getElementById('adminPassword').focus();
            }, 100);
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'guruhebat2025') {
                closeAdminPasswordDialog();
                document.getElementById('adminPanel').classList.remove('hidden');
                
                // Initialize admin panel
                showAdminSection('createQuiz');
                refreshSidebarStats();
                
                alert('✅ Selamat datang di Panel Admin!');
            } else {
                alert('❌ Password salah! Coba lagi.');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        function closeAdminPasswordDialog() {
            const dialog = document.getElementById('adminPasswordDialog');
            if (dialog) {
                dialog.remove();
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // Admin Sidebar Functions
        function toggleAdminSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const mainContent = document.getElementById('adminMainContent');
            const toggle = document.getElementById('adminSidebarToggle');
            
            if (sidebar.classList.contains('admin-sidebar-collapsed')) {
                // Expand sidebar
                sidebar.classList.remove('admin-sidebar-collapsed');
                sidebar.classList.remove('w-16');
                sidebar.classList.add('w-64');
                mainContent.classList.remove('admin-main-expanded');
                mainContent.classList.remove('ml-16');
                mainContent.classList.add('ml-64');
                toggle.classList.add('hidden');
            } else {
                // Collapse sidebar
                sidebar.classList.add('admin-sidebar-collapsed');
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-16');
                mainContent.classList.add('admin-main-expanded');
                mainContent.classList.remove('ml-64');
                mainContent.classList.add('ml-16');
                toggle.classList.remove('hidden');
            }
        }

        function showAdminSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.admin-section');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Remove active state from all nav buttons
            const navButtons = document.querySelectorAll('.admin-nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('bg-blue-100', 'text-blue-700');
            });
            
            // Show selected section
            const targetSection = document.getElementById('admin' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1));
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Add active state to clicked nav button
            const activeButton = event.target.closest('.admin-nav-btn');
            if (activeButton) {
                activeButton.classList.add('active', 'bg-blue-100', 'text-blue-700');
            }
            
            // Load section-specific data
            switch(sectionName) {
                case 'stats':
                    refreshAllStats();
                    break;
                case 'createQuiz':
                    refreshSidebarStats();
                    break;
            }
        }

        async function refreshSidebarStats() {
            try {
                const { data: savedQuizzes } = await supabase.from('quizzes').select('id');
                const { data: participants } = await supabase.from('participants').select('id').eq('is_active', true);
                const { data: activeQuizzes } = await supabase.from('quizzes').select('id').eq('status', 'active');
                
                // Update stats in the appropriate section, not in sidebar
                document.getElementById('statsQuizCount').textContent = savedQuizzes?.length || 0;
                document.getElementById('statsParticipantCount').textContent = participants?.length || 0;
                document.getElementById('statsActiveQuiz').textContent = activeQuizzes?.length || 0;
            } catch (error) {
                console.error('Error refreshing sidebar stats:', error);
            }
        }

        async function refreshAllStats() {
            try {
                const { data: allQuizzes } = await supabase.from('quizzes').select('id, status');
                const { data: allParticipants } = await supabase.from('participants').select('id');
                
                const totalQuizzes = allQuizzes?.length || 0;
                const totalParticipants = allParticipants?.length || 0;
                const activeQuizzes = allQuizzes?.filter(q => q.status === 'active').length || 0;
                const completedQuizzes = allQuizzes?.filter(q => q.status === 'completed').length || 0;
                
                // Update stats section
                document.getElementById('statsQuizCount').textContent = totalQuizzes;
                document.getElementById('statsParticipantCount').textContent = totalParticipants;
                document.getElementById('statsActiveQuiz').textContent = activeQuizzes;
                document.getElementById('statsCompletedQuiz').textContent = completedQuizzes;
                
            } catch (error) {
                console.error('Error refreshing all stats:', error);
            }
        }

        // Initialize admin panel on first load
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial active state for create quiz button
            const createQuizBtn = document.querySelector('[onclick="showAdminSection(\'createQuiz\')"]');
            if (createQuizBtn) {
                createQuizBtn.classList.add('active', 'bg-blue-100', 'text-blue-700');
            }
        });

        function backToHome() {
            const currentUser = gameState.currentUser; // Preserve user session
            
            gameState = {
                currentScreen: 'welcome',
                currentQuiz: null,
                currentParticipant: null,
                currentUser: currentUser, // Keep user logged in
                currentQuestionIndex: 0,
                score: 0,
                timeRemaining: 15,
                timer: null,
                questions: []
            };
            
            document.getElementById('gameCode').classList.add('hidden');
            document.getElementById('joinCode').value = '';
            
            if (currentUser) {
                showScreen('welcomeScreen');
            } else {
                showScreen('loginScreen');
            }
        }

        // Additional functions for other panels can be added here...
        // These would include showQuizLibrary, showMonitoringPanel, showResultsManager, etc.
        // For brevity, I've included the core functionality above.

    </script>
</body>
</html>
